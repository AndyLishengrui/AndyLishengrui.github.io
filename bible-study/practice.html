<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¡«ç©ºç»ƒä¹  | åœ£ç»å­¦ä¹ åŠ©æ‰‹</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'PingFang SC', 'Microsoft YaHei', Arial, sans-serif;
            line-height: 1.6;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .header {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            text-align: center;
            color: white;
        }
        
        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .back-button {
            position: absolute;
            left: 20px;
            top: 20px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .back-button:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .settings-panel {
            background: white;
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .settings-title {
            font-size: 1.8em;
            margin-bottom: 30px;
            color: #333;
        }
        
        .setting-group {
            margin-bottom: 25px;
        }
        
        .setting-label {
            display: block;
            font-size: 1.1em;
            margin-bottom: 10px;
            color: #555;
            text-align: left;
        }
        
        .setting-select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1em;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s ease;
        }
        
        .setting-select:focus {
            outline: none;
            border-color: #4facfe;
        }
        
        .difficulty-options {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .difficulty-btn {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            padding: 15px 20px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            min-width: 140px;
        }
        
        .difficulty-btn.active {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            color: white;
            border-color: transparent;
        }
        
        .start-btn {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 25px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }
        
        .start-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(79, 172, 254, 0.4);
        }
        
        .practice-area {
            background: white;
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            text-align: center;
            display: none;
        }
        
        .verse-display {
            font-size: 1.5em;
            line-height: 2;
            margin-bottom: 30px;
            color: #333;
        }
        
        .blank-input {
            border: none;
            border-bottom: 2px solid #4facfe;
            background: transparent;
            font-size: 1.5em;
            text-align: center;
            width: 40px;
            margin: 0 2px;
            padding: 2px;
        }
        
        .blank-input:focus {
            outline: none;
            border-bottom-color: #00f2fe;
        }
        
        .blank-input.correct {
            background-color: #d4edda;
            border-bottom-color: #28a745;
            transform: scale(1.02);
        }
        
        .blank-input.incorrect {
            background-color: #f8d7da;
            border-bottom-color: #dc3545;
            animation: shake 0.5s;
        }
        
        .correct-answer {
            color: #27ae60 !important;
            margin-left: 5px;
            font-size: 0.85em;
            font-weight: bold;
            display: inline-block;
            white-space: nowrap;
        }
        
        .blank-container {
            position: relative;
            display: inline-block;
        }
        
        .hint-icon {
            transition: all 0.3s ease;
            opacity: 0.7;
        }
        
        .blank-container:hover .hint-icon {
            opacity: 1;
            transform: scale(1.1);
        }
        
        .blank-container[title]:hover::after {
            content: attr(title);
            position: absolute;
            bottom: -35px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8em;
            white-space: nowrap;
            z-index: 1000;
            pointer-events: none;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        

        
        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }
        
        .action-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(102, 126, 234, 0.4);
        }
        
        .progress-info {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            color: white;
            text-align: center;
        }
        
        /* æ–°çš„å¡ç‰‡å¼é€‰æ‹©æ ·å¼ */
        .step-container {
            margin-bottom: 30px;
        }
        
        .step-title {
            font-size: 1.4em;
            color: #333;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }
        
        .books-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .book-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 12px 8px;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .book-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }
        
        .book-card.selected {
            border-color: #ffd700;
            background: linear-gradient(135deg, #4facfe, #00f2fe);
        }
        
        .book-card-title {
            font-size: 0.9em;
            font-weight: bold;
            margin-bottom: 3px;
            line-height: 1.2;
        }
        
        .book-card-subtitle {
            font-size: 0.7em;
            opacity: 0.9;
            line-height: 1.1;
        }
        
        .selected-book-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            border-left: 4px solid #4facfe;
        }
        
        .chapters-section {
            margin-bottom: 25px;
        }
        
        .chapters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 10px;
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .chapter-btn {
            background: white;
            border: 2px solid #e9ecef;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-weight: bold;
        }
        
        .chapter-btn:hover {
            background: #e3f2fd;
            border-color: #4facfe;
        }
        
        .chapter-btn.selected {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            color: white;
            border-color: transparent;
        }
        
        .secondary-btn {
            background: #6c757d !important;
        }
        
        .secondary-btn:hover {
            background: #5a6268 !important;
        }
        
        /* ç»ƒä¹ åŒºåŸŸæ ·å¼ */
        .practice-area {
            display: none;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin-top: 20px;
        }
        
        .verse-progress {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .progress-info {
            color: #666;
            font-size: 13px;
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        
        /* å¤šèŠ‚ç»æ–‡å®¹å™¨æ ·å¼ */
        .verses-container {
            max-height: 75vh;
            overflow-y: auto;
            margin: 15px 0;
        }
        
        .verse-group {
            background: #ffffff;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin: 8px 0;
            padding: 15px;
            transition: all 0.2s ease;
        }
        
        .verse-group:hover {
            border-color: #4facfe;
            box-shadow: 0 3px 10px rgba(79, 172, 254, 0.1);
        }
        
        .verse-reference-inline {
            font-weight: bold;
            color: #4facfe;
            font-size: 13px;
            margin-right: 8px;
            font-style: italic;
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 4px;
            border: 1px solid #e9ecef;
            display: inline-block;
            vertical-align: top;
        }
        
        .edit-verse-btn {
            background: #ffc107;
            border: none;
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 10px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-left: 8px;
            opacity: 0.7;
            transition: all 0.3s ease;
            float: right;
        }
        
        .edit-verse-btn:hover {
            opacity: 1;
            transform: scale(1.1);
            background: #e0a800;
        }
        
        .verse-text {
            clear: both;
            margin-top: 5px;
        }
        
        .verse-content {
            font-size: 16px;
            line-height: 1.8;
            text-align: left;
            margin: 0;
            padding: 15px 20px;
            background: #ffffff;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        

        
        .reference-text {
            color: #666;
            font-style: italic;
            font-size: 16px;
        }
        
        /* å¡«ç©ºè¾“å…¥æ¡†æ ·å¼ */
        .blank-input {
            border: none;
            border-bottom: 2px solid #ddd;
            background: #f8f9fa;
            font-size: inherit;
            border-radius: 3px;
            font-family: inherit;
            text-align: center;
            margin: 0 4px;
            padding: 2px 4px;
            transition: all 0.3s ease;
            min-width: 60px;
        }
        
        .blank-input:focus {
            outline: none;
            border-bottom-color: #4facfe;
            background: rgba(79, 172, 254, 0.1);
        }
        
        .blank-input.correct {
            border-bottom-color: #28a745;
            background: rgba(40, 167, 69, 0.1);
            color: #28a745;
        }
        
        .blank-input.incorrect {
            border-bottom-color: #dc3545;
            background: rgba(220, 53, 69, 0.1);
            color: #dc3545;
        }
        
        /* é¼“åŠ±ä¿¡æ¯æ ·å¼ */
        .encouragement-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(40, 167, 69, 0.95);
            color: white;
            padding: 15px 25px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 500;
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.3);
            animation: encouragementFade 3s ease-in-out;
            z-index: 1000;
        }
        
        .encouragement-content {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        @keyframes encouragementFade {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            20% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
        }
        
        @media (max-width: 768px) {
            .difficulty-options {
                flex-direction: column;
                align-items: center;
            }
            
            .action-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .verse-content {
                font-size: 16px;
                padding: 15px;
            }
            
            .practice-area {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <button class="back-button" onclick="goBackToBookSelection()">
            <i class="fas fa-arrow-left"></i> è¿”å›ä¹¦å·é€‰æ‹©
        </button>
        <div class="progress-info" id="progressInfo" style="display: none;">
            <span id="progressText">ç¬¬ 1 é¢˜ / å…± 10 é¢˜</span> | 
            <span>å¾—åˆ†: <span id="currentScore">0</span></span>
        </div>
    </div>

    <div class="container">
        <!-- GitHub Pages é™æ€ç‰ˆæœ¬æç¤º -->
        <div id="static-notice" style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 10px; margin: 10px 0; border-radius: 5px; font-size: 14px;">
            ğŸ“‹ <strong>é™æ€ç‰ˆæœ¬è¯´æ˜</strong>: æ­¤ä¸º GitHub Pages æ‰˜ç®¡ç‰ˆæœ¬ï¼Œåœ¨çº¿ç¼–è¾‘åŠŸèƒ½å·²ç¦ç”¨ã€‚å¦‚éœ€ç¼–è¾‘ç»æ–‡ï¼Œè¯·ä¸‹è½½å®Œæ•´ç‰ˆæœ¬åœ¨æœ¬åœ°ä½¿ç”¨ã€‚
        </div>
        
        <!-- è®¾ç½®é¢æ¿ -->
        <div class="settings-panel" id="settingsPanel">
            <h2 class="settings-title"><i class="fas fa-cog"></i> æ™ºèƒ½å¡«ç©ºç»ƒä¹ </h2>
            
            <!-- æ­¥éª¤1ï¼šé€‰æ‹©ä¹¦å· -->
            <div class="step-container" id="bookSelectionStep">
                <h3 class="step-title">ğŸ“š é€‰æ‹©å­¦ä¹ ä¹¦å·</h3>
                <div class="books-grid" id="booksGrid">
                    <!-- ä¹¦å·å¡ç‰‡å°†åŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
            
            <!-- æ­¥éª¤2ï¼šé€‰æ‹©ç« èŠ‚å’Œéš¾åº¦ -->
            <div class="step-container" id="chapterSelectionStep" style="display: none;">
                <h3 class="step-title">ğŸ“– é€‰æ‹©ç« èŠ‚ä¸éš¾åº¦</h3>
                <div class="selected-book-info" id="selectedBookInfo">
                    <!-- æ˜¾ç¤ºå·²é€‰æ‹©çš„ä¹¦å·ä¿¡æ¯ -->
                </div>
                
                <div class="chapters-section">
                    <label class="setting-label">é€‰æ‹©ç« èŠ‚ï¼š</label>
                    <div class="chapters-grid" id="chaptersGrid">
                        <!-- ç« èŠ‚æŒ‰é’®å°†åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
                
                <div class="setting-group">
                    <label class="setting-label">é€‰æ‹©éš¾åº¦ï¼š</label>
                    <div class="difficulty-options">
                        <div class="difficulty-btn active" data-difficulty="easy">
                            <i class="fas fa-star"></i> ç®€å• <br><small>(2-3ä¸ªç©º)</small>
                        </div>
                        <div class="difficulty-btn" data-difficulty="medium">
                            <i class="fas fa-star"></i><i class="fas fa-star"></i> ä¸­ç­‰ <br><small>(4-5ä¸ªç©º)</small>
                        </div>
                        <div class="difficulty-btn" data-difficulty="hard">
                            <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i> å›°éš¾ <br><small>(6+ä¸ªç©º)</small>
                        </div>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="action-btn secondary-btn" onclick="backToBookSelection()">
                        <i class="fas fa-arrow-left"></i> é‡é€‰ä¹¦å·
                    </button>
                    <button class="action-btn" id="verseEditorBtn" title="ç»æ–‡æ ¡å¯¹å·¥å…·" style="background: linear-gradient(135deg, #ffc107, #ff8c00);">
                        <i class="fas fa-edit"></i> ç»æ–‡æ ¡å¯¹
                    </button>
                    <button class="start-btn" onclick="startPractice()">
                        <i class="fas fa-play"></i> å¼€å§‹ç»ƒä¹ 
                    </button>
                </div>
                
                <!-- è°ƒè¯•ä¿¡æ¯ -->
                <div style="margin-top: 10px; font-size: 12px; color: #666; text-align: center;">
                    è°ƒè¯•: <span id="debugInfo">ç­‰å¾…é€‰æ‹©...</span>
                </div>
            </div>
        </div>

        <!-- ç»ƒä¹ åŒºåŸŸ -->
        <div class="practice-area" id="practiceArea">
            <div class="verse-display" id="verseDisplay">
                <!-- ç»æ–‡å†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
            <div class="verse-reference" id="verseReference">
                <!-- ç»æ–‡å¼•ç”¨å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
            <div class="action-buttons">
                <button class="action-btn" onclick="checkAnswer()">
                    <i class="fas fa-check"></i> æ£€æŸ¥ç­”æ¡ˆ
                </button>
                <button class="action-btn" onclick="showHint()">
                    <i class="fas fa-lightbulb"></i> æç¤º
                </button>
                <button class="action-btn" id="nextBtn" style="display: none;">
                    <i class="fas fa-arrow-right"></i> ä¸‹ä¸€ç»„
                </button>
            </div>
        </div>

        <!-- ç»“æœé¢æ¿ -->
        <div class="settings-panel" id="resultsPanel" style="display: none;">
            <h2 class="settings-title"><i class="fas fa-trophy"></i> ç»ƒä¹ ç»“æœ</h2>
            <div style="font-size: 1.2em; margin: 20px 0;">
                <p>æ€»é¢˜æ•°: <span id="totalAnswered">0</span></p>
                <p>æ­£ç¡®æ•°: <span id="correctAnswers">0</span></p>
                <p>å‡†ç¡®ç‡: <span id="accuracyRate">0%</span></p>
                <p>ç”¨æ—¶: <span id="timeSpent">0ç§’</span></p>
            </div>
            <div class="action-buttons">
                <button class="action-btn" onclick="restartPractice()">
                    <i class="fas fa-redo"></i> é‡æ–°ç»ƒä¹ 
                </button>
                <button class="action-btn" onclick="goHome()">
                    <i class="fas fa-home"></i> è¿”å›é¦–é¡µ
                </button>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let booksData = {};
        let currentBook = '';
        let currentChapter = 1;
        let currentVerses = [];
        let currentVerseIndex = 0;
        let difficulty = 'easy';
        let score = 0;
        let totalQuestions = 0;
        let correctAnswers = 0;
        let startTime = 0;

        

        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('é¡µé¢DOMåŠ è½½å®Œæˆ');
            
            // å¼ºåˆ¶ç­‰å¾…ä¸€ç‚¹æ—¶é—´ç¡®ä¿DOMå®Œå…¨åŠ è½½
            setTimeout(() => {
                console.log('å¼€å§‹åŠ¨æ€åŠ è½½ä¹¦å·æ•°æ®...');
                
                const booksGrid = document.getElementById('booksGrid');
                console.log('booksGridå…ƒç´ :', booksGrid);
                
                if (booksGrid) {
                    console.log('æ‰¾åˆ°booksGridï¼Œå¼€å§‹åŠ¨æ€åŠ è½½...');
                    // ä½¿ç”¨åŠ¨æ€åŠ è½½æ›¿ä»£é™æ€æ•°æ®
                    loadBooksData();
                } else {
                    console.error('æœªæ‰¾åˆ°booksGridå…ƒç´ ï¼');
                    // å°è¯•åœ¨æ•´ä¸ªæ–‡æ¡£ä¸­æŸ¥æ‰¾
                    console.log('æ‰€æœ‰IDä¸ºbooksGridçš„å…ƒç´ :', document.querySelectorAll('#booksGrid'));
                }
                
            }, 100);
            
            initializeEventListeners();
        });

        // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
        function initializeEventListeners() {
            // éš¾åº¦é€‰æ‹©
            document.querySelectorAll('.difficulty-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.difficulty-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    difficulty = this.dataset.difficulty;
                    console.log('é€‰æ‹©éš¾åº¦:', difficulty);
                });
            });

            // ç»æ–‡æ ¡å¯¹æŒ‰é’®
            const verseEditorBtn = document.getElementById('verseEditorBtn');
            if (verseEditorBtn) {
                console.log('æ‰¾åˆ°ç»æ–‡æ ¡å¯¹æŒ‰é’®ï¼Œæ·»åŠ ç‚¹å‡»äº‹ä»¶');
                verseEditorBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('ç»æ–‡æ ¡å¯¹æŒ‰é’®è¢«ç‚¹å‡»');
                    openVerseEditor();
                });
            } else {
                console.error('æœªæ‰¾åˆ°ç»æ–‡æ ¡å¯¹æŒ‰é’®');
            }

            // æ—§çš„ä¸‹æ‹‰é€‰æ‹©å™¨å·²è¢«å¡ç‰‡å¼é€‰æ‹©æ›¿ä»£
            // æ–°çš„äº¤äº’é€šè¿‡ selectBook() å’Œ selectChapter() å‡½æ•°å¤„ç†
        }

        // åŠ è½½ä¹¦å·æ•°æ®
        // æ–°å¢å…¨å±€å˜é‡
        let selectedBook = '';
        let selectedChapter = 1;
        
        async function loadBooksData() {
            try {
                console.log('å¼€å§‹åŠ è½½é…ç½®æ–‡ä»¶...');
                const response = await fetch('data/config.json');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const config = await response.json();
                console.log('é…ç½®åŠ è½½æˆåŠŸ:', config);
                
                if (!config.availableBooks || config.availableBooks.length === 0) {
                    throw new Error('é…ç½®æ–‡ä»¶ä¸­æ²¡æœ‰å¯ç”¨ä¹¦å·');
                }
                
                // ç”Ÿæˆä¹¦å·å¡ç‰‡
                await generateBookCards(config);
                
            } catch (error) {
                console.error('åŠ è½½é…ç½®å¤±è´¥:', error);
                alert('åŠ è½½ä¹¦å·æ•°æ®å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            }
        }
        
        // ç”Ÿæˆä¹¦å·å¡ç‰‡
        async function generateBookCards(config) {
            console.log('å¼€å§‹ç”Ÿæˆä¹¦å·å¡ç‰‡...');
            const booksGrid = document.getElementById('booksGrid');
            
            if (!booksGrid) {
                console.error('æ‰¾ä¸åˆ°booksGridå…ƒç´ ');
                return;
            }
            
            console.log('æ‰¾åˆ°booksGridå…ƒç´ ï¼Œæ¸…ç©ºå†…å®¹');
            booksGrid.innerHTML = '';
            
            console.log('å¯ç”¨ä¹¦å·:', config.availableBooks);
            
            // é¦–å…ˆæ˜¾ç¤ºä¹¦å·å¡ç‰‡ï¼Œå³ä½¿æ²¡æœ‰åŠ è½½æ•°æ®
            for (let bookKey of config.availableBooks) {
                const bookConfig = config.books[bookKey];
                if (bookConfig) {
                    // åˆ›å»ºä¹¦å·å¡ç‰‡ï¼ˆåªä½¿ç”¨é…ç½®ä¿¡æ¯ï¼‰
                    const bookCard = document.createElement('div');
                    bookCard.className = 'book-card';
                    bookCard.dataset.bookKey = bookKey;
                    // è®¾ç½®ä¹¦å·å¡ç‰‡é¢œè‰²
                    if (bookConfig.color) {
                        bookCard.style.background = `linear-gradient(135deg, ${bookConfig.color}, ${adjustColor(bookConfig.color, -20)})`;
                    }
                    
                    bookCard.innerHTML = `
                        <div class="book-card-title">${bookConfig.name}</div>
                        <div class="book-card-subtitle">${bookConfig.chapters} ç« </div>
                    `;
                    
                    bookCard.addEventListener('click', () => selectBook(bookKey, bookConfig.name, config));
                    booksGrid.appendChild(bookCard);
                    
                    console.log(`åˆ›å»ºå¡ç‰‡: ${bookKey} - ${bookConfig.name}`);
                }
            }
            
            // åå°åŠ è½½è¯¦ç»†æ•°æ®
            loadDetailedBookData(config);
            
        }
        
        // é¢œè‰²è°ƒæ•´å‡½æ•°ï¼ˆåŠ æ·±æˆ–å˜æµ…ï¼‰
        function adjustColor(color, percent) {
            const num = parseInt(color.replace('#', ''), 16);
            const amt = Math.round(2.55 * percent);
            const R = (num >> 16) + amt;
            const G = (num >> 8 & 0x00FF) + amt;
            const B = (num & 0x0000FF) + amt;
            return '#' + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
                (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
                (B < 255 ? B < 1 ? 0 : B : 255)).toString(16).slice(1);
        }
        
        // é¢œè‰²è°ƒæ•´å‡½æ•°ï¼ˆåŠ æ·±æˆ–å˜æµ…ï¼‰
        function adjustColor(color, percent) {
            const num = parseInt(color.replace('#', ''), 16);
            const amt = Math.round(2.55 * percent);
            const R = (num >> 16) + amt;
            const G = (num >> 8 & 0x00FF) + amt;
            const B = (num & 0x0000FF) + amt;
            return '#' + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
                (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
                (B < 255 ? B < 1 ? 0 : B : 255)).toString(16).slice(1);
        }
        
        // åå°åŠ è½½è¯¦ç»†ä¹¦å·æ•°æ®
        async function loadDetailedBookData(config) {
            console.log('å¼€å§‹åå°åŠ è½½è¯¦ç»†æ•°æ®...');
            
            for (let bookKey of config.availableBooks) {
                try {
                    console.log(`æ­£åœ¨åŠ è½½ ${bookKey}.json`);
                    const bookResponse = await fetch(`data/${bookKey}.json`);
                    if (!bookResponse.ok) {
                        console.warn(`æ— æ³•åŠ è½½ ${bookKey}.json: HTTP ${bookResponse.status}`);
                        continue;
                    }
                    const bookData = await bookResponse.json();
                    
                    // åˆå¹¶é…ç½®ä¿¡æ¯å’Œä¹¦å·æ•°æ®
                    booksData[bookKey] = {
                        ...bookData,
                        ...config.books[bookKey]
                    };
                    
                    console.log(`æˆåŠŸåŠ è½½ ${bookKey}: ${bookData.name}`);
                } catch (error) {
                    console.error(`æ— æ³•åŠ è½½ ${bookKey}.json:`, error);
                }
            }
            
            console.log('æ‰€æœ‰ä¹¦å·æ•°æ®åŠ è½½å®Œæˆ:', Object.keys(booksData));
        }

        // é€‰æ‹©ä¹¦å·
        function selectBook(bookKey, bookName, config) {
            selectedBook = bookKey;
            currentBook = bookKey;
            
            console.log('é€‰æ‹©ä¹¦å·:', bookKey, bookName);
            
            // æ›´æ–°å¡ç‰‡é€‰æ‹©çŠ¶æ€
            document.querySelectorAll('.book-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.querySelector(`[data-book-key="${bookKey}"]`).classList.add('selected');
            
            // è·å–ç« èŠ‚æ•°ï¼ˆä»é…ç½®æˆ–å·²åŠ è½½çš„æ•°æ®ï¼‰
            const chapters = (booksData[bookKey] && booksData[bookKey].chapters) || 
                           (config && config.books[bookKey] && config.books[bookKey].chapters) || 
                           1;
            
            // æ˜¾ç¤ºé€‰æ‹©çš„ä¹¦å·ä¿¡æ¯
            const selectedBookInfo = document.getElementById('selectedBookInfo');
            selectedBookInfo.innerHTML = `
                <h4>ğŸ“š å·²é€‰æ‹©: ${bookName}</h4>
                <p>å…± ${chapters} ç«  | ç‚¹å‡»ä¸‹æ–¹é€‰æ‹©è¦ç»ƒä¹ çš„ç« èŠ‚</p>
            `;
            
            // ç”Ÿæˆç« èŠ‚é€‰æ‹©
            generateChapterButtons(chapters);
            
            // æ˜¾ç¤ºç¬¬äºŒæ­¥
            document.getElementById('bookSelectionStep').style.display = 'none';
            document.getElementById('chapterSelectionStep').style.display = 'block';
        }
        
        // Fallbacké€‰æ‹©ä¹¦å·å‡½æ•°
        function selectBookFallback(bookKey, bookName, chapters) {
            selectedBook = bookKey;
            currentBook = bookKey;
            
            console.log('Fallbacké€‰æ‹©ä¹¦å·:', bookKey, bookName);
            
            // æ›´æ–°å¡ç‰‡é€‰æ‹©çŠ¶æ€
            document.querySelectorAll('.book-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.querySelector(`[data-book-key="${bookKey}"]`).classList.add('selected');
            
            // æ˜¾ç¤ºé€‰æ‹©çš„ä¹¦å·ä¿¡æ¯
            const selectedBookInfo = document.getElementById('selectedBookInfo');
            selectedBookInfo.innerHTML = `
                <h4>ğŸ“š å·²é€‰æ‹©: ${bookName}</h4>
                <p>å…± ${chapters} ç«  | ç‚¹å‡»ä¸‹æ–¹é€‰æ‹©è¦ç»ƒä¹ çš„ç« èŠ‚</p>
            `;
            
            // ç”Ÿæˆç« èŠ‚é€‰æ‹©
            generateChapterButtons(chapters);
            
            // æ˜¾ç¤ºç¬¬äºŒæ­¥
            document.getElementById('bookSelectionStep').style.display = 'none';
            document.getElementById('chapterSelectionStep').style.display = 'block';
        }
        
        // ç”Ÿæˆç« èŠ‚æŒ‰é’®
        function generateChapterButtons(totalChapters = 1) {
            console.log('ç”Ÿæˆç« èŠ‚æŒ‰é’®ï¼Œæ€»ç« æ•°:', totalChapters);
            const chaptersGrid = document.getElementById('chaptersGrid');
            
            if (!chaptersGrid) {
                console.error('æ‰¾ä¸åˆ° chaptersGrid å…ƒç´ ');
                return;
            }
            
            chaptersGrid.innerHTML = '';
            
            for (let i = 1; i <= totalChapters; i++) {
                const chapterBtn = document.createElement('div');
                chapterBtn.className = 'chapter-btn';
                chapterBtn.textContent = i;
                chapterBtn.dataset.chapter = i;
                
                if (i === 1) {
                    chapterBtn.classList.add('selected');
                    selectedChapter = 1;
                }
                
                chapterBtn.addEventListener('click', () => {
                    console.log('é€‰æ‹©ç« èŠ‚:', i);
                    selectChapter(i);
                });
                chaptersGrid.appendChild(chapterBtn);
            }
            
            console.log('ç« èŠ‚æŒ‰é’®ç”Ÿæˆå®Œæˆï¼Œå…±ç”Ÿæˆ:', totalChapters, 'ä¸ªæŒ‰é’®');
            updateDebugInfo();
        }
        
        // æ›´æ–°è°ƒè¯•ä¿¡æ¯
        function updateDebugInfo() {
            const debugInfo = document.getElementById('debugInfo');
            if (debugInfo) {
                debugInfo.textContent = `å·²é€‰: ${selectedBook || 'æ— '} - ç¬¬${selectedChapter || 0}ç« `;
            }
        }
        
        // é€‰æ‹©ç« èŠ‚
        function selectChapter(chapter) {
            selectedChapter = chapter;
            currentChapter = chapter;
            
            console.log('ç« èŠ‚é€‰æ‹©æ›´æ–°:', chapter);
            
            // æ›´æ–°æŒ‰é’®é€‰æ‹©çŠ¶æ€
            document.querySelectorAll('.chapter-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            const selectedBtn = document.querySelector(`[data-chapter="${chapter}"]`);
            if (selectedBtn) {
                selectedBtn.classList.add('selected');
            }
            
            // æ›´æ–°è°ƒè¯•ä¿¡æ¯
            updateDebugInfo();
        }
        
        // è¿”å›ä¹¦å·é€‰æ‹©
        function backToBookSelection() {
            document.getElementById('chapterSelectionStep').style.display = 'none';
            document.getElementById('bookSelectionStep').style.display = 'block';
            
            // é‡ç½®é€‰æ‹©
            document.querySelectorAll('.book-card').forEach(card => {
                card.classList.remove('selected');
            });
            selectedBook = '';
            selectedChapter = 1;
        }
        
        // åºŸå¼ƒçš„æ—§å‡½æ•°ï¼ˆä¿æŒå…¼å®¹æ€§ï¼‰
        function loadChapters() {
            // è¿™ä¸ªå‡½æ•°å·²è¢«æ–°çš„å¡ç‰‡å¼é€‰æ‹©æ›¿ä»£
            console.log('loadChapters å·²è¢«æ–°çš„ç« èŠ‚é€‰æ‹©åŠŸèƒ½æ›¿ä»£');
        }

        // å¼€å§‹ç»ƒä¹ 
        async function startPractice() {
            if (!selectedBook || !selectedChapter) {
                alert('è¯·é€‰æ‹©ä¹¦å·å’Œç« èŠ‚');
                return;
            }
            
            currentBook = selectedBook;
            currentChapter = selectedChapter;
            
            console.log('å¼€å§‹åŠ è½½ç»ƒä¹ æ•°æ®:', currentBook, 'ç¬¬', currentChapter, 'ç« ');
            
            try {
                // å°è¯•åŠ è½½æ•°æ®
                await loadVerseData(selectedBook, selectedChapter);
                
                // éšè—è®¾ç½®é¢æ¿ï¼Œæ˜¾ç¤ºç»ƒä¹ åŒºåŸŸ
                document.getElementById('settingsPanel').style.display = 'none';
                document.getElementById('practiceArea').style.display = 'block';
                
                // æ˜¾ç¤ºç¬¬ä¸€èŠ‚ç»æ–‡
                displayCurrentVerse();
                
            } catch (error) {
                console.error('åŠ è½½ç»æ–‡æ•°æ®å¤±è´¥:', error);
                alert(`æ— æ³•åŠ è½½ ${getBookName(selectedBook)} ç¬¬${selectedChapter}ç« çš„æ•°æ®ã€‚\n\n${error.message}`);
            }
        }
        
        // åŠ è½½ç»æ–‡æ•°æ®
        async function loadVerseData(bookKey, chapter) {
            console.log(`å¼€å§‹åŠ è½½ ${bookKey} ç¬¬${chapter}ç« æ•°æ®...`);
            
            try {
                // å°è¯•ä»JSONæ–‡ä»¶åŠ è½½æ•°æ®
                const response = await fetch(`data/${bookKey}.json`);
                
                if (!response.ok) {
                    throw new Error(`æ— æ³•æ‰¾åˆ° ${getBookName(bookKey)} çš„æ•°æ®æ–‡ä»¶`);
                }
                
                const data = await response.json();
                console.log('æ•°æ®åŠ è½½æˆåŠŸ:', data);
                
                if (!data.verses || data.verses.length === 0) {
                    throw new Error('æ•°æ®æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®æˆ–æ²¡æœ‰ç»æ–‡å†…å®¹');
                }
                
                // ç­›é€‰æŒ‡å®šç« èŠ‚çš„ç»æ–‡
                const chapterVerses = data.verses.filter(verse => verse.chapter === chapter);
                
                if (chapterVerses.length === 0) {
                    throw new Error(`ç¬¬${chapter}ç« æ²¡æœ‰æ‰¾åˆ°ç»æ–‡æ•°æ®`);
                }
                
                console.log(`æ‰¾åˆ° ${chapterVerses.length} èŠ‚ç»æ–‡`);
                
                // éšæœºé€‰æ‹©æœ€å¤š10èŠ‚ç»æ–‡è¿›è¡Œç»ƒä¹ 
                currentVerses = shuffleArray(chapterVerses).slice(0, Math.min(10, chapterVerses.length));
                currentVerseIndex = 0;
                score = 0;
                totalQuestions = currentVerses.length;
                correctAnswers = 0;
                startTime = Date.now();
                
            } catch (error) {
                // å¦‚æœåŠ è½½å¤±è´¥ï¼Œä½¿ç”¨ç¤ºä¾‹æ•°æ®
                console.warn('æ— æ³•åŠ è½½çœŸå®æ•°æ®ï¼Œä½¿ç”¨ç¤ºä¾‹æ•°æ®:', error);
                createSampleVerses(bookKey, chapter);
            }
        }
        
        // åˆ›å»ºç¤ºä¾‹ç»æ–‡ï¼ˆå½“æ— æ³•åŠ è½½çœŸå®æ•°æ®æ—¶ï¼‰
        function createSampleVerses(bookKey, chapter) {
            const bookName = getBookName(bookKey);
            
            // åˆ›å»ºä¸€äº›ç¤ºä¾‹ç»æ–‡ç”¨äºæ¼”ç¤º
            const sampleVerses = [
                {
                    chapter: chapter,
                    verse: 1,
                    text: "è¿™æ˜¯ä¸€èŠ‚ç¤ºä¾‹ç»æ–‡ï¼Œç”¨äºæ¼”ç¤ºæ™ºèƒ½å¡«ç©ºç»ƒä¹ åŠŸèƒ½çš„æ•ˆæœã€‚æˆ‘ä»¬ä¼šå°†é‡è¦çš„ç¥å­¦æœ¯è¯­å’Œæ¦‚å¿µè®¾ä¸ºå¡«ç©ºã€‚"
                },
                {
                    chapter: chapter, 
                    verse: 2,
                    text: "ç¥å°±æ˜¯çˆ±ï¼Œä½åœ¨çˆ±é‡Œé¢çš„ï¼Œå°±æ˜¯ä½åœ¨ç¥é‡Œé¢ï¼Œç¥ä¹Ÿä½åœ¨ä»–é‡Œé¢ã€‚"
                },
                {
                    chapter: chapter,
                    verse: 3, 
                    text: "ä½ ä»¬è¦å½¼æ­¤ç›¸çˆ±ï¼Œåƒæˆ‘çˆ±ä½ ä»¬ä¸€æ ·ã€‚è¿™å°±æ˜¯æˆ‘çš„å‘½ä»¤ã€‚"
                }
            ];
            
            currentVerses = sampleVerses;
            currentVerseIndex = 0;
            score = 0;
            totalQuestions = currentVerses.length;
            correctAnswers = 0;
            startTime = Date.now();
            
            console.log('ä½¿ç”¨ç¤ºä¾‹æ•°æ®ï¼Œå…±', currentVerses.length, 'èŠ‚ç»æ–‡');
        }
        
        // è·å–ä¹¦å·ä¸­æ–‡åç§°
        function getBookName(bookKey) {
            const bookNames = {
                'matthew': 'é©¬å¤ªç¦éŸ³',
                'mark': 'é©¬å¯ç¦éŸ³', 
                'luke': 'è·¯åŠ ç¦éŸ³',
                'john': 'çº¦ç¿°ç¦éŸ³',
                'acts': 'ä½¿å¾’è¡Œä¼ ',
                'romans': 'ç½—é©¬ä¹¦',
                'ephesians': 'ä»¥å¼—æ‰€ä¹¦'
            };
            return bookNames[bookKey] || bookKey;
        }
        
        // è¿”å›é¦–é¡µå‡½æ•°
        function goHome() {
            window.location.href = 'index.html';
        }
        
        // é‡ç½®ç»Ÿè®¡æ•°æ®ï¼ˆè°ƒè¯•ç”¨ï¼‰
        function resetStats() {
            if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰ç»Ÿè®¡æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
                localStorage.removeItem('userProgress');
                alert('ç»Ÿè®¡æ•°æ®å·²é‡ç½®');
                location.reload();
            }
        }
        
        // åœ¨æ§åˆ¶å°æ·»åŠ é‡ç½®å‘½ä»¤
        window.resetStats = resetStats;
        
        // æ˜¾ç¤ºå½“å‰ç»æ–‡å¹¶ç”Ÿæˆå¡«ç©ºï¼ˆä¸€æ¬¡æ˜¾ç¤º5èŠ‚ï¼‰
        function displayCurrentVerse() {
            if (!currentVerses || currentVerseIndex >= currentVerses.length) {
                console.error('æ²¡æœ‰ç»æ–‡æ•°æ®æˆ–ç´¢å¼•è¶…å‡ºèŒƒå›´');
                return;
            }
            
            // è·å–å½“å‰ç»„çš„5èŠ‚ç»æ–‡
            const versesToShow = [];
            for (let i = 0; i < 5 && (currentVerseIndex + i) < currentVerses.length; i++) {
                versesToShow.push(currentVerses[currentVerseIndex + i]);
            }
            
            console.log(`æ˜¾ç¤ºç¬¬ ${currentVerseIndex + 1}-${currentVerseIndex + versesToShow.length}/${currentVerses.length} èŠ‚ç»æ–‡:`, versesToShow);
            
            // ç”Ÿæˆæ‰€æœ‰ç»æ–‡çš„HTML
            let versesHtml = '';
            versesToShow.forEach((verse, index) => {
                const verseText = verse.text || verse.zh || 'ç»æ–‡å†…å®¹åŠ è½½å¤±è´¥';
                const blankedText = createBlankedVerse(verseText);
                const bookName = getBookName(currentBook);
                const verseId = `${currentBook}_${verse.chapter}_${verse.verse}`;
                
                versesHtml += `
                    <div class="verse-group" data-verse-id="${verseId}">
                        <div class="verse-content">
                            <span class="verse-reference-inline">${bookName} ${verse.chapter}:${verse.verse}</span>
                            <button class="edit-verse-btn" data-verse-id="${verseId}" data-original-text="${verseText.replace(/"/g, '&quot;')}" data-book-name="${bookName}" data-chapter="${verse.chapter}" data-verse="${verse.verse}" title="ç¼–è¾‘ç»æ–‡">
                                <i class="fas fa-edit"></i>
                            </button>
                            <div class="verse-text" data-original="${verseText.replace(/"/g, '&quot;')}">${blankedText}</div>
                        </div>
                    </div>
                `;
            });
            
            // æ˜¾ç¤ºç»æ–‡å†…å®¹
            const verseDisplay = document.getElementById('verseDisplay');
            verseDisplay.innerHTML = `
                <div class="verse-progress">
                    <span class="progress-info">ç¬¬${Math.floor(currentVerseIndex/5) + 1}ç»„ (${currentVerseIndex + 1}-${currentVerseIndex + versesToShow.length}/${currentVerses.length}èŠ‚)</span>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${((currentVerseIndex + versesToShow.length) / currentVerses.length * 100)}%"></div>
                    </div>
                </div>
                <div class="verses-container">${versesHtml}</div>
            `;
            
            // æ¸…ç©ºç»æ–‡å¼•ç”¨åŒºåŸŸï¼ˆç°åœ¨å¼•ç”¨åœ¨æ¯èŠ‚ç»æ–‡ä¸Šæ–¹ï¼‰
            const verseReference = document.getElementById('verseReference');
            verseReference.innerHTML = '';
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            const nextBtn = document.getElementById('nextBtn');
            nextBtn.style.display = 'none';
            
            // åˆ¤æ–­æ˜¯å¦ä¸ºæœ€åä¸€ç»„
            const isLastGroup = (currentVerseIndex + versesToShow.length) >= currentVerses.length;
            if (isLastGroup) {
                nextBtn.innerHTML = '<i class="fas fa-check-circle"></i> æäº¤ç­”æ¡ˆ';
                nextBtn.onclick = showResults;
            } else {
                nextBtn.innerHTML = '<i class="fas fa-arrow-right"></i> ä¸‹ä¸€ç»„';
                nextBtn.onclick = nextVerse;
            }
            
            // æ·»åŠ è¾“å…¥æ¡†äº‹ä»¶ç›‘å¬å™¨
            addInputEventListeners();
        }
        
        // ä¸ºå¡«ç©ºè¾“å…¥æ¡†æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
        function addInputEventListeners() {
            const inputs = document.querySelectorAll('.blank-input');
            inputs.forEach(input => {
                // è‡ªåŠ¨æ£€æŸ¥ç­”æ¡ˆ
                input.addEventListener('input', function() {
                    const userAnswer = this.value.trim();
                    const correctAnswer = this.dataset.answer;
                    
                    // ç§»é™¤ä¹‹å‰çš„çŠ¶æ€
                    this.classList.remove('correct', 'incorrect');
                    
                    if (userAnswer && userAnswer === correctAnswer) {
                        this.classList.add('correct');
                        // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰ç©ºéƒ½å¡«å¯¹äº†
                        checkAllBlanks();
                    } else if (userAnswer && userAnswer !== correctAnswer) {
                        this.classList.add('incorrect');
                    }
                });
                
                // å›è½¦é”®è·³åˆ°ä¸‹ä¸€ä¸ªè¾“å…¥æ¡†
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        const allInputs = Array.from(document.querySelectorAll('.blank-input'));
                        const currentIndex = allInputs.indexOf(this);
                        if (currentIndex < allInputs.length - 1) {
                            allInputs[currentIndex + 1].focus();
                        }
                    }
                });
            });
            
            // ä¸ºç¼–è¾‘æŒ‰é’®æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            const editButtons = document.querySelectorAll('.edit-verse-btn');
            editButtons.forEach(button => {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    const verseId = this.dataset.verseId;
                    const originalText = this.dataset.originalText;
                    const bookName = this.dataset.bookName;
                    const chapter = this.dataset.chapter;
                    const verse = this.dataset.verse;
                    
                    console.log('ç¼–è¾‘æŒ‰é’®è¢«ç‚¹å‡»:', {verseId, originalText, bookName, chapter, verse});
                    
                    editVerse(verseId, originalText, bookName, chapter, verse);
                });
            });
        }
        
        // æ£€æŸ¥æ‰€æœ‰å¡«ç©ºæ˜¯å¦éƒ½æ­£ç¡®
        function checkAllBlanks() {
            const inputs = document.querySelectorAll('.blank-input');
            let allCorrect = true;
            
            inputs.forEach(input => {
                if (!input.classList.contains('correct')) {
                    allCorrect = false;
                }
            });
            
            if (allCorrect && inputs.length > 0) {
                // æ‰€æœ‰ç­”æ¡ˆéƒ½æ­£ç¡®ï¼Œæ˜¾ç¤ºé¼“åŠ±ä¿¡æ¯å’Œä¸‹ä¸€é¢˜æŒ‰é’®
                setTimeout(() => {
                    showEncouragement();
                    correctAnswers++;
                    document.getElementById('nextBtn').style.display = 'inline-block';
                }, 500);
            }
        }
        
        // æ˜¾ç¤ºé¼“åŠ±ä¿¡æ¯
        function showEncouragement() {
            const encouragements = [
                "å¾ˆå¥½ï¼ç»§ç»­åŠ æ²¹ï¼ ğŸ’ª",
                "ç­”å¯¹äº†ï¼ç¥çš„è¯è¯­å¾ˆå®è´µ âœ¨",
                "æ£’æäº†ï¼ä½ è®°å¾—å¾ˆæ¸…æ¥š ğŸŒŸ", 
                "å¤ªå¥½äº†ï¼ç»§ç»­å­¦ä¹ ç¥çš„è¯è¯­ ğŸ“–",
                "åšå¾—å¾ˆæ£’ï¼ç¥å¿…èµç¦ç»™ä½  ğŸ™",
                "ç­”æ¡ˆæ­£ç¡®ï¼æ„¿ç¥çš„è¯è¯­å¸¸åœ¨ä½ å¿ƒä¸­ â¤ï¸"
            ];
            
            const randomIndex = Math.floor(Math.random() * encouragements.length);
            const message = encouragements[randomIndex];
            
            // åˆ›å»ºé¼“åŠ±æç¤º
            const encouragementDiv = document.createElement('div');
            encouragementDiv.className = 'encouragement-message';
            encouragementDiv.innerHTML = `
                <div class="encouragement-content">
                    <i class="fas fa-check-circle"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.getElementById('verseDisplay').appendChild(encouragementDiv);
            
            // 3ç§’åç§»é™¤
            setTimeout(() => {
                if (encouragementDiv.parentNode) {
                    encouragementDiv.parentNode.removeChild(encouragementDiv);
                }
            }, 3000);
        }

        // è¿”å›é¦–é¡µå‡½æ•°
        function goHome() {
            window.location.href = 'index.html';
        }

        // æ˜¾ç¤ºå½“å‰ç»æ–‡
        function showCurrentVerse() {
            const verse = currentVerses[currentVerseIndex];
            const verseDisplay = document.getElementById('verseDisplay');
            const verseReference = document.getElementById('verseReference');
            
            // ç”Ÿæˆå¡«ç©ºç»æ–‡
            const blankedVerse = createBlankedVerse(verse.text || verse.zh);
            verseDisplay.innerHTML = blankedVerse;
            const bookName = getBookName(currentBook);
            verseReference.textContent = `${bookName} ${verse.chapter}:${verse.verse}`;
            
            // æ›´æ–°è¿›åº¦
            updateProgress();
            
            // é‡ç½®æŒ‰é’®çŠ¶æ€
            document.getElementById('nextBtn').style.display = 'none';
        }

        // æå–æœ‰æ„ä¹‰çš„è¯è¯­ï¼ˆä»study.htmlå¤ç”¨ï¼‰
        function extractMeaningfulWords(text) {
            // ç¡®ä¿è¾“å…¥æ˜¯æœ‰æ•ˆå­—ç¬¦ä¸²
            if (!text || typeof text !== 'string') {
                console.error('extractMeaningfulWords: æ— æ•ˆçš„æ–‡æœ¬è¾“å…¥:', text);
                return [];
            }
            
            const meaningfulWords = [];
            
            // é«˜ä¼˜å…ˆçº§è¯ç»„æ¨¡å¼ï¼ˆ2-7å­—ï¼‰
            const phrasePatterns = [
                'ä¸Šå¸çš„å„¿å¥³', 'ç¥çš„å›½åº¦', 'è€¶ç¨£åŸºç£', 'åœ£çµå……æ»¡', 'æ•‘ä¸»è€¶ç¨£', 'å¤©çˆ¶ä¸Šå¸',
                'åŸºç£çš„èº«ä½“', 'ç¥çš„æ—¨æ„', 'ä¸»çš„å‘½ä»¤', 'åœ£çµçš„æœå­', 'ç¥çš„æ©å…¸', 'ä¸»çš„é“è·¯',
                'æ°¸ç”Ÿç¥çš„', 'åˆ›é€ ä¸‡ç‰©', 'å…¨èƒ½çš„ç¥', 'ä¸‡ç‰©çš„ä¸»', 'è£è€€çš„ç‹',
                'åœ£æ´æ— ç‘•', 'å…¬ä¹‰å’Œå¹³', 'æ…ˆçˆ±å’ŒçœŸç†', 'æ©å…¸å’ŒçœŸç†', 'ä¿¡æœ›å’Œçˆ±',
                'å¹³å®‰å’Œå–œä¹', 'è°¦å‘å’Œæ¸©æŸ”', 'è‰¯å–„å’Œå¿è€', 'æ¸©æŸ”è°¦å‘', 'å–„è‰¯å¿ åš'
            ];
            
            // é¦–å…ˆæœç´¢é«˜ä¼˜å…ˆçº§çš„å®Œæ•´è¯ç»„
            phrasePatterns.forEach(phrase => {
                const index = text.indexOf(phrase);
                if (index !== -1 && phrase.length >= 2 && phrase.length <= 7) {
                    meaningfulWords.push({
                        word: phrase,
                        index: index,
                        category: 'important-phrase',
                        priority: phrase.length * 4,
                        length: phrase.length
                    });
                }
            });
            
            // ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æå–å…¶ä»–æœ‰æ„ä¹‰çš„è¯ç»„ï¼ˆ2-7å­—ï¼‰
            const phraseRegex = /[ä¸€-é¾¥]{2,7}/g;
            let match;
            
            while ((match = phraseRegex.exec(text)) !== null) {
                const phrase = match[0];
                const index = match.index;
                
                if (!isCommonWord(phrase) && 
                    !meaningfulWords.find(w => w.word === phrase)) {
                    
                    let priority = phrase.length;
                    
                    if (isTheologicalTerm(phrase)) {
                        priority *= 3;
                    } else if (isVerbPhrase(phrase)) {
                        priority *= 2.5;
                    }
                    
                    meaningfulWords.push({
                        word: phrase,
                        index: index,
                        category: 'phrase',
                        priority: priority,
                        length: phrase.length
                    });
                }
            }
            
            return meaningfulWords.sort((a, b) => b.priority - a.priority);
        }
        
        // åˆ¤æ–­æ˜¯å¦ä¸ºå¸¸è§è™šè¯
        function isCommonWord(phrase) {
            const commonWords = [
                'çš„äºº', 'äº†å—', 'è¿˜æ˜¯', 'å°±æ˜¯', 'éƒ½æ˜¯', 'ä¹Ÿæ˜¯', 'ä¸æ˜¯', 
                'å¯ä»¥', 'åº”è¯¥', 'å¯èƒ½', 'ä¹Ÿè®¸', 'æˆ–è€…', 'ä½†æ˜¯', 'è€Œä¸”',
                'å¦‚æœ', 'å› ä¸º', 'æ‰€ä»¥', 'ç„¶å', 'äºæ˜¯', 'å› æ­¤', 'ç„¶è€Œ',
                'è¿™ä¸ª', 'é‚£ä¸ª', 'è¿™äº›', 'é‚£äº›', 'è¿™æ ·', 'é‚£æ ·'
            ];
            
            return commonWords.some(word => phrase.includes(word)) || 
                   /^[ï¼Œã€‚ï¼›ï¼šï¼ï¼Ÿ""''ï¼ˆï¼‰ã€ã€‘ã€Šã€‹]+$/.test(phrase);
        }
        
        // åˆ¤æ–­æ˜¯å¦ä¸ºç¥å­¦æœ¯è¯­ï¼ˆæ‰©å……ç‰ˆï¼‰
        function isTheologicalTerm(phrase) {
            const coreTheologicalTerms = [
                // ç¥çš„å±æ€§å’Œåç§°
                'ç¥', 'ä¸Šå¸', 'è€¶å’Œå', 'ä¸»', 'çˆ¶', 'å¤©çˆ¶', 'å…¨èƒ½è€…', 'åˆ›é€ ä¸»', 'æ•‘èµä¸»',
                
                // ä¸‰ä½ä¸€ä½“
                'è€¶ç¨£', 'åŸºç£', 'æ•‘ä¸»', 'ä¸»è€¶ç¨£', 'è€¶ç¨£åŸºç£', 'åœ£å­', 'äººå­', 'ç¥çš„å„¿å­',
                'åœ£çµ', 'ä¿æƒ å¸ˆ', 'çœŸç†çš„çµ', 'ç¥çš„çµ',
                
                // æ•‘æ©æ¦‚å¿µ
                'æ•‘æ©', 'æ•‘èµ', 'æ©å…¸', 'æ€œæ‚¯', 'æ…ˆçˆ±', 'é¥¶æ•', 'èµ¦å…', 'ç§°ä¹‰', 'æˆåœ£',
                'é‡ç”Ÿ', 'å¾—æ•‘', 'æ°¸ç”Ÿ', 'å¤æ´»', 'å‡å¤©', 'å†æ¥',
                
                // å±çµæ¦‚å¿µ
                'ä¿¡å¿ƒ', 'ç›¼æœ›', 'çˆ±å¿ƒ', 'çœŸç†', 'å…¬ä¹‰', 'åœ£æ´', 'è‰¯å–„', 'å¿ å¿ƒ', 'é¡ºæœ',
                'è°¦å‘', 'æ¸©æŸ”', 'å¿è€', 'èŠ‚åˆ¶', 'æ™ºæ…§', 'çŸ¥è¯†', 'æ•¬ç•',
                
                // æ•™ä¼šå’Œäº‹å·¥
                'æ•™ä¼š', 'é—¨å¾’', 'ä½¿å¾’', 'é•¿è€', 'æ‰§äº‹', 'å¼Ÿå…„', 'å§å¦¹', 'åœ£å¾’',
                'äº‹å¥‰', 'ä¾å¥‰', 'æœäº‹', 'ä¼ é“', 'ç¦éŸ³', 'è§è¯', 'å®£æ•™',
                
                // åœ£ç»å’Œè¯è¯­
                'åœ£ç»', 'ç»æ–‡', 'è¯è¯­', 'çœŸé“', 'å¾‹æ³•', 'è¯«å‘½', 'åº”è®¸', 'é¢„è¨€',
                
                // å±çµäº‰æˆ˜
                'è¯•æ¢', 'ç½ªæ¶', 'æ’’ä½†', 'é­”é¬¼', 'ä¸–ç•Œ', 'è‚‰ä½“', 'äº‰æˆ˜',
                
                // å¤©å›½å’Œæ°¸æ’
                'å¤©å›½', 'å›½åº¦', 'å¤©å ‚', 'æ°¸ç”Ÿ', 'æ°¸è¿œ', 'è£è€€', 'å®åº§', 'å®¡åˆ¤'
            ];
            
            const conceptualPhrases = [
                // é‡è¦çš„ç¥å­¦çŸ­è¯­
                'å› ä¿¡ç§°ä¹‰', 'æ©å…¸æ—¶ä»£', 'ç¥çš„æ—¨æ„', 'ä¸»çš„æ©å…¸', 'åœ£çµå……æ»¡',
                'åŸºç£çš„çˆ±', 'ç¥çš„å›½åº¦', 'å¤©çˆ¶çš„çˆ±', 'ä¸»çš„æ€œæ‚¯', 'ç¥çš„è£è€€',
                'æ°¸è¿œçš„ç”Ÿå‘½', 'æ•‘æ©çš„ç›¼æœ›', 'çœŸç†çš„é“', 'ç”Ÿå‘½çš„ç²®', 'ä¸–ç•Œçš„å…‰'
            ];
            
            // æ£€æŸ¥æ˜¯å¦åŒ…å«æ ¸å¿ƒç¥å­¦æœ¯è¯­
            const hasCoreTerm = coreTheologicalTerms.some(term => phrase.includes(term));
            // æ£€æŸ¥æ˜¯å¦æ˜¯é‡è¦çš„æ¦‚å¿µçŸ­è¯­
            const hasConceptPhrase = conceptualPhrases.some(concept => phrase.includes(concept));
            
            return hasCoreTerm || hasConceptPhrase;
        }
        
        // åˆ¤æ–­æ˜¯å¦æ˜¯åŠ¨è¯çŸ­è¯­ï¼ˆæœ‰åŠ©äºè®°å¿†åŠ¨æ€åœºæ™¯ï¼‰
        function isVerbPhrase(word) {
            const actionVerbs = [
                "è¯´", "è®²", "å‘Šè¯‰", "å®£å‘Š", "å‘¼å–Š", "å›ç­”", "é—®", "å¬è§", "çœ‹è§",
                "æ¥", "å»", "èµ°", "è·‘", "è·Ÿä»", "ç¦»å¼€", "è¿›å…¥", "å‡ºæ¥", "å›å»",
                "ç«™èµ·", "åä¸‹", "èµ·æ¥", "èººä¸‹", "è·ªä¸‹", "ä¿¯ä¼", "ä¸¾æ‰‹",
                "æ‹¿", "ç»™", "å¸¦", "é¢†", "é€’", "æ”¾", "æ‰”", "ä¼¸å‡º", "æŠ“ä½",
                "åŒ»æ²»", "æ´å‡€", "èµ¶å‡º", "æŒ‰æ‰‹", "ç¥·å‘Š", "ç¥ç¦", "å®‰æ…°", "æ‰¶æŒ",
                "ä¼ è®²", "æ•™è®­", "åŠå‹‰", "è´£å¤‡", "è­¦å‘Š", "å©å’", "å‘½ä»¤",
                "çˆ±", "æ¨", "å–œæ‚¦", "å¿§æ„", "å®³æ€•", "æƒŠå¥‡", "æ„Ÿè°¢", "èµç¾"
            ];
                          
            const actionPhrases = [
                "èµ·æ¥", "ä¸‹æ¥", "è¿‡æ¥", "å›æ¥", "å‡ºå»", "è¿›å»", "ä¸Šå»",
                "ä¼¸å‡ºæ‰‹", "ä¸¾èµ·æ‰‹", "ä½ä¸‹å¤´", "æŠ¬èµ·å¤´", "çå¼€çœ¼", "é—­ä¸Šçœ¼",
                "ä¿¯ä¼æ•¬æ‹œ", "è·ªä¸‹ç¥·å‘Š", "ä¸¾æ‰‹èµç¾", "å¼€å£è¯´è¯", "ä¾§è€³å¬",
                "æ”¾ä¸‹", "æ‹¿èµ·", "æ‹¥æŠ±", "å¯»æ‰¾", "å¯»æ±‚", "å‘¼æ±‚", "å€šé "
            ];
            
            return actionVerbs.some(verb => word.includes(verb)) || 
                   actionPhrases.some(phrase => word.includes(phrase));
        }
        
        // åˆ¤æ–­æ˜¯å¦ä¸ºåŠ¨è¯çŸ­è¯­
        function isVerbPhrase(phrase) {
            const verbIndicators = [
                'è¯´', 'æ¥', 'å»', 'åš', 'è¡Œ', 'èµ°', 'ç«™', 'å', 'çœ‹', 'å¬',
                'çˆ±', 'ä¿¡', 'æœ›', 'æ±‚', 'ç»™', 'å¾—', 'æˆ', 'ç«‹', 'å»º', 'é€ '
            ];
            return verbIndicators.some(verb => phrase.includes(verb));
        }
        
        // é€‰æ‹©ç”¨äºå¡«ç©ºçš„è¯è¯­ï¼ˆè®°å¿†å¯¼å‘ä¼˜åŒ–ï¼‰
        function selectWordsForBlanks(meaningfulWords, text) {
            const blankCount = getBlankCount(text.length);
            const selectedWords = [];
            
            console.log(`ç»æ–‡é•¿åº¦: ${text.length}, è®¡åˆ’å¡«ç©ºæ•°é‡: ${blankCount}`);
            const usedIndices = new Set();
            
            // æŒ‰å­¦ä¹ ä»·å€¼é‡æ–°æ’åº
            meaningfulWords.sort((a, b) => {
                // ä¼˜å…ˆçº§è®¡ç®—ï¼šç¥å­¦æœ¯è¯­ > åŠ¨è¯çŸ­è¯­ > é•¿è¯ç»„ > çŸ­è¯ç»„
                let scoreA = a.priority;
                let scoreB = b.priority;
                
                // ç»™ç¥å­¦æœ¯è¯­é¢å¤–åŠ åˆ†
                if (isTheologicalTerm(a.word)) scoreA += 20;
                if (isTheologicalTerm(b.word)) scoreB += 20;
                
                // ç»™åŠ¨ä½œè¯ç»„åŠ åˆ†ï¼ˆæœ‰åŠ©äºè®°å¿†åŠ¨æ€åœºæ™¯ï¼‰
                if (isVerbPhrase(a.word)) scoreA += 15;
                if (isVerbPhrase(b.word)) scoreB += 15;
                
                // é€‚ä¸­é•¿åº¦çš„è¯ç»„æ›´æœ‰è®°å¿†ä»·å€¼ï¼ˆ3-5å­—ï¼‰
                if (a.word.length >= 3 && a.word.length <= 5) scoreA += 10;
                if (b.word.length >= 3 && b.word.length <= 5) scoreB += 10;
                
                // äººç§°ä»£è¯å’Œç§°å‘¼æœ‰åŠ©äºè®°å¿†å¯¹è¯æƒ…å¢ƒ
                if (['ä½ ', 'æˆ‘', 'ä»–', 'å¤«å­', 'å…ˆç”Ÿ', 'è€å¸ˆ'].some(pronoun => a.word.includes(pronoun))) {
                    scoreA += 8;
                }
                if (['ä½ ', 'æˆ‘', 'ä»–', 'å¤«å­', 'å…ˆç”Ÿ', 'è€å¸ˆ'].some(pronoun => b.word.includes(pronoun))) {
                    scoreB += 8;
                }
                
                return scoreB - scoreA;
            });
            
            console.log('æŒ‰è®°å¿†ä»·å€¼æ’åºçš„è¯è¯­:', meaningfulWords);
            console.log('æœ€ç»ˆå†³å®šçš„å¡«ç©ºæ•°é‡:', blankCount);
            
            for (const word of meaningfulWords) {
                if (selectedWords.length >= blankCount) break;
                if (word.word.length < 2 || word.word.length > 7) continue;
                
                let hasOverlap = false;
                const wordEnd = word.index + word.word.length;
                
                for (let i = word.index; i < wordEnd; i++) {
                    if (usedIndices.has(i)) {
                        hasOverlap = true;
                        break;
                    }
                }
                
                if (!hasOverlap) {
                    selectedWords.push(word);
                    for (let i = word.index; i < wordEnd; i++) {
                        usedIndices.add(i);
                    }
                    
                    console.log(`é€‰æ‹©å¡«ç©ºè¯è¯­: "${word.word}" (ç±»åˆ«: ${word.category}, ä¼˜å…ˆçº§: ${word.priority})`);
                }
            }
            
            return selectedWords;
        }
        
        // è®¡ç®—è¾“å…¥æ¡†å®½åº¦
        function calculateInputWidth(text) {
            return Math.max(text.length * 20, 40);
        }
        
        // åˆå¹¶ç›¸é‚»çš„è¾“å…¥æ¡† - ä¸´æ—¶æ³¨é‡Šæ‰ä¿®å¤è¯­æ³•é”™è¯¯
        function mergeAdjacentInputs(html) {
            // ç®€åŒ–ç‰ˆæœ¬ï¼Œæš‚æ—¶ä¸åˆå¹¶
            return html;
            
            // åŸç‰ˆæœ¬æš‚æ—¶æ³¨é‡Šæ‰
            /*
            return html.replace(
                /(<input[^>]*>)\s*(<input[^>]*>)/g,
                function(match, input1, input2) {
                    const answer1 = input1.match(/data-answer="([^"]*)")/) || ['', ''];
                    const answer2 = input2.match(/data-answer="([^"]*)")/) || ['', ''];
                    const combinedAnswer = answer1[1] + answer2[1];
                    const baseWidth = calculateInputWidth(combinedAnswer);
                    const fixedWidth = Math.max(baseWidth + 10, 70);
                    const placeholder = 'â–¡'.repeat(combinedAnswer.length);
                    
                    return `<input type="text" class="blank-input" data-answer="${combinedAnswer}" placeholder="${placeholder}" style="width: ${fixedWidth}px;">`;
                }
            );
            */
        }
        
        // åˆ›å»ºå¡«ç©ºç»æ–‡ï¼ˆä½¿ç”¨æ™ºèƒ½ç®—æ³•ï¼‰
        function createBlankedVerse(text) {
            console.log('åŸæ–‡:', text);
            
            // æ£€æŸ¥è¾“å…¥æ˜¯å¦æœ‰æ•ˆ
            if (!text || typeof text !== 'string') {
                console.error('createBlankedVerse: æ— æ•ˆçš„æ–‡æœ¬è¾“å…¥:', text);
                return 'ç»æ–‡å†…å®¹åŠ è½½å¤±è´¥ï¼Œè¯·é‡æ–°é€‰æ‹©ã€‚';
            }
            
            // ä½¿ç”¨æ™ºèƒ½ç®—æ³•æå–æœ‰æ„ä¹‰çš„è¯è¯­
            const meaningfulWords = extractMeaningfulWords(text);
            const selectedWords = selectWordsForBlanks(meaningfulWords, text);
            
            console.log('æå–çš„æœ‰æ„ä¹‰è¯è¯­:', meaningfulWords);
            console.log('é€‰ä¸­çš„å¡«ç©ºè¯è¯­:', selectedWords);
            
            let blankedVerse = text;
            // æŒ‰ç…§è¯è¯­é•¿åº¦ä»é•¿åˆ°çŸ­æ’åºï¼Œé¿å…æ›¿æ¢å†²çª
            selectedWords.sort((a, b) => b.word.length - a.word.length);
            
            selectedWords.forEach(wordInfo => {
                const baseWidth = calculateInputWidth(wordInfo.word);
                const fixedWidth = Math.max(baseWidth + 10, 50);
                const placeholder = 'â–¡'.repeat(wordInfo.word.length);
                
                // æ·»åŠ å­¦ä¹ æç¤ºï¼ˆä»…é¼ æ ‡æ‚¬æµ®ï¼‰
                let hint = '';
                if (isTheologicalTerm(wordInfo.word)) {
                    hint = 'ğŸ’¡ç¥å­¦æœ¯è¯­';
                } else if (isVerbPhrase(wordInfo.word)) {
                    hint = 'ğŸ­åŠ¨ä½œè¯';
                } else if (wordInfo.word.length >= 4) {
                    hint = 'ğŸ“é‡è¦è¯ç»„';
                } else {
                    hint = 'âœ’ï¸å…³é”®è¯';
                }
                
                // åˆ›å»ºç®€æ´çš„å¡«ç©ºè¾“å…¥æ¡†ï¼ˆé¼ æ ‡æ‚¬æµ®æ˜¾ç¤ºæç¤ºï¼‰
                const inputHTML = `<input type="text" class="blank-input" 
                           data-answer="${wordInfo.word}" 
                           placeholder="${placeholder}" 
                           title="æç¤ºï¼š${wordInfo.word} ${hint}"
                           style="width: ${fixedWidth}px; margin: 0 2px;">`;
                
                blankedVerse = blankedVerse.replace(wordInfo.word, inputHTML);
            });
            
            // åˆå¹¶ç›¸é‚»çš„è¾“å…¥æ¡†
            blankedVerse = mergeAdjacentInputs(blankedVerse);
            
            console.log('ç”Ÿæˆçš„HTML:', blankedVerse);
            return blankedVerse;
        }

        // æ ¹æ®éš¾åº¦è·å–å¡«ç©ºæ•°é‡
        function getBlankCount(textLength = 50) {
            // ä½¿ç”¨ä¼ å…¥çš„ç»æ–‡é•¿åº¦æ¥åŠ¨æ€è°ƒæ•´å¡«ç©ºæ•°é‡
            console.log('ç»æ–‡é•¿åº¦:', textLength);
            
            // æ ¹æ®ç»æ–‡é•¿åº¦å’Œéš¾åº¦è®¡ç®—å¡«ç©ºæ•°é‡
            let baseCount;
            if (textLength <= 30) {
                // çŸ­ç»æ–‡ï¼š1ä¸ªç©º
                baseCount = 1;
            } else if (textLength <= 60) {
                // ä¸­ç­‰ç»æ–‡ï¼š2ä¸ªç©º
                baseCount = 2;
            } else {
                // é•¿ç»æ–‡ï¼š3ä¸ªç©º
                baseCount = 3;
            }
            
            // æ ¹æ®éš¾åº¦å¾®è°ƒ
            switch (difficulty) {
                case 'easy': 
                    return Math.max(1, baseCount - 1); // ç®€å•æ¨¡å¼å‡å°‘1ä¸ª
                case 'medium': 
                    return baseCount; // ä¸­ç­‰æ¨¡å¼ä½¿ç”¨åŸºç¡€æ•°é‡
                case 'hard': 
                    return Math.min(4, baseCount + 1); // å›°éš¾æ¨¡å¼å¢åŠ 1ä¸ªï¼Œä½†æœ€å¤š4ä¸ª
                default: 
                    return baseCount;
            }
        }

        // æ£€æŸ¥ç­”æ¡ˆï¼ˆå‚è€ƒstudy.htmlçš„å®Œå–„ç‰ˆæœ¬ï¼‰
        function checkAnswer() {
            const inputs = document.querySelectorAll('.blank-input');
            let correct = 0;
            let total = inputs.length;
            
            console.log('å¼€å§‹æ£€æŸ¥ç­”æ¡ˆï¼Œæ€»è¾“å…¥æ¡†æ•°:', total);
            
            // æ£€æŸ¥æ˜¯å¦å·²ç»æ£€æŸ¥è¿‡ï¼ˆé˜²æ­¢é‡å¤è®¡ç®—ç»Ÿè®¡æ•°æ®ï¼‰
            const alreadyChecked = document.querySelector('.blank-input.correct, .blank-input.incorrect') !== null;
            
            // å…ˆæ¸…é™¤æ‰€æœ‰ä¹‹å‰çš„æ­£ç¡®ç­”æ¡ˆæ˜¾ç¤º
            document.querySelectorAll('.correct-answer').forEach(answer => answer.remove());
            
            inputs.forEach((input, index) => {
                input.classList.remove('correct', 'incorrect');
                
                const userAnswer = input.value.trim().replace(/\s+/g, ''); // å»é™¤æ‰€æœ‰ç©ºæ ¼
                const correctAnswer = input.dataset.answer.replace(/\s+/g, '');
                
                console.log(`è¾“å…¥æ¡†${index}: ç”¨æˆ·ç­”æ¡ˆ="${userAnswer}", æ­£ç¡®ç­”æ¡ˆ="${correctAnswer}"`);
                
                if (userAnswer === correctAnswer || userAnswer.toLowerCase() === correctAnswer.toLowerCase()) {
                    input.classList.add('correct');
                    correct++;
                } else {
                    input.classList.add('incorrect');
                    
                    // åˆ›å»ºæ­£ç¡®ç­”æ¡ˆæ˜¾ç¤ºå…ƒç´ 
                    const correctAnswerSpan = document.createElement('span');
                    correctAnswerSpan.className = 'correct-answer';
                    correctAnswerSpan.style.cssText = 'color: #27ae60; margin-left: 5px; font-size: 0.85em; font-weight: bold; display: inline-block;';
                    correctAnswerSpan.textContent = `(${input.dataset.answer})`;
                    
                    // åœ¨è¾“å…¥æ¡†åæ’å…¥æ­£ç¡®ç­”æ¡ˆ
                    const container = input.parentElement;
                    const nextElement = input.nextSibling;
                    
                    if (nextElement) {
                        container.insertBefore(correctAnswerSpan, nextElement);
                    } else {
                        container.appendChild(correctAnswerSpan);
                    }
                }
            });
            
            console.log(`æ£€æŸ¥ç»“æœ: æ­£ç¡®${correct}/${total}`);
            
            // åªæœ‰é¦–æ¬¡æ£€æŸ¥æ—¶æ‰æ›´æ–°ç»Ÿè®¡æ•°æ®
            if (!alreadyChecked) {
                totalQuestions += total;
                correctAnswers += correct;
                console.log(`ç»Ÿè®¡æ›´æ–°: æ€»é¢˜æ•°+${total}, æ­£ç¡®æ•°+${correct}`);
            }
            
            // æ˜¾ç¤ºæ¸©å’Œçš„å­¦ä¹ åé¦ˆ
            const resultHTML = document.getElementById('verseReference');
            if (correct === total) {
                if (!alreadyChecked) {
                    score += 100;
                    console.log('å…¨éƒ¨æ­£ç¡®ï¼å¾—100åˆ†');
                }
                
                const encouragements = [
                    'ğŸŒŸ å¤ªæ£’äº†ï¼ä½ å®Œå…¨æŒæ¡äº†è¿™æ®µç»æ–‡çš„è¦ç‚¹ï¼',
                    'âœ¨ åšå¾—å¾ˆå¥½ï¼ç¥çš„è¯è¯­å·²ç»æ·±æ·±å°åœ¨ä½ å¿ƒé‡Œï¼',
                    'ğŸ‰ å®Œç¾ï¼ä½ å¯¹è¿™äº›ç¥å­¦æ¦‚å¿µç†è§£å¾—å¾ˆé€å½»ï¼',
                    'ğŸ’« ä¼˜ç§€ï¼è¿™äº›é‡è¦çš„è¯è¯­ä½ éƒ½è®°ä½äº†ï¼',
                    'ğŸ† ç²¾å½©ï¼ä½ çš„è®°å¿†åŠ›çœŸæ˜¯ä»¤äººèµå¹ï¼'
                ];
                
                const randomEncouragement = encouragements[Math.floor(Math.random() * encouragements.length)];
                resultHTML.innerHTML += `<br><span style="color: #27ae60; font-weight: bold; font-size: 1.05em;">${randomEncouragement}</span>`;
                
            } else {
                const partialScore = Math.floor((correct / total) * 100);
                score += partialScore;
                console.log(`éƒ¨åˆ†æ­£ç¡®ï¼Œå¾—${partialScore}åˆ†`);
                
                let feedbackMessage;
                const accuracy = correct / total;
                
                if (accuracy >= 0.8) {
                    const goodMessages = [
                        `ğŸ“– å¾ˆä¸é”™ï¼ä½ ç­”å¯¹äº† ${correct}/${total} ä¸ªï¼Œåªå·®ä¸€ç‚¹ç‚¹å°±å®Œç¾äº†ï¼`,
                        `ğŸŒ± åšå¾—å¾ˆå¥½ï¼${correct}/${total} ä¸ªæ­£ç¡®ç­”æ¡ˆï¼Œä½ æ­£åœ¨ç¨³æ­¥è¿›æ­¥ï¼`,
                        `ğŸ’¡ æ£’æäº†ï¼ä½ å¯¹å¤§éƒ¨åˆ†å†…å®¹éƒ½æŒæ¡å¾—å¾ˆå¥½ï¼`
                    ];
                    feedbackMessage = goodMessages[Math.floor(Math.random() * goodMessages.length)];
                } else if (accuracy >= 0.5) {
                    const encouragingMessages = [
                        `ğŸ“š ä¸é”™çš„å¼€å§‹ï¼ç­”å¯¹äº† ${correct}/${total} ä¸ªï¼Œç»§ç»­åŠªåŠ›è®°å¿†è¿™äº›é‡è¦æ¦‚å¿µï¼`,
                        `ğŸŒ¿ æ­£åœ¨è¿›æ­¥ä¸­ï¼${correct}/${total} ä¸ªæ­£ç¡®ï¼Œå¤šè¯»å‡ éä¼šæ›´ç†Ÿæ‚‰ï¼`,
                        `ğŸ’ª ç»§ç»­åŠ æ²¹ï¼ä½ å·²ç»æŒæ¡äº†ä¸€åŠä»¥ä¸Šçš„å†…å®¹ï¼`
                    ];
                    feedbackMessage = encouragingMessages[Math.floor(Math.random() * encouragingMessages.length)];
                } else {
                    const gentleMessages = [
                        `ğŸŒ± æ²¡å…³ç³»ï¼Œå­¦ä¹ éœ€è¦è¿‡ç¨‹ï¼å¤šè¯»å‡ éè¿™æ®µç»æ–‡ï¼Œé‡ç‚¹å…³æ³¨é‚£äº›é‡è¦çš„è¯è¯­ï¼`,
                        `ğŸ“– è¿™æ˜¯å¾ˆå¥½çš„å­¦ä¹ æœºä¼šï¼é‡æ–°é˜…è¯»ç»æ–‡ï¼Œç‰¹åˆ«ç•™æ„ç¥å­¦æœ¯è¯­çš„å«ä¹‰ï¼`,
                        `ğŸ’ ä¸è¦ç°å¿ƒï¼ç¥çš„è¯è¯­éœ€è¦åå¤é»˜æƒ³æ‰èƒ½æ·±å…¥äººå¿ƒï¼`
                    ];
                    feedbackMessage = gentleMessages[Math.floor(Math.random() * gentleMessages.length)];
                }
                
                resultHTML.innerHTML += `<br><span style="color: #3498db; font-weight: bold;">${feedbackMessage}</span>`;
            }
            
            // æ˜¾ç¤ºä¸‹ä¸€æ­¥æŒ‰é’®
            document.getElementById('nextBtn').style.display = 'inline-block';
        }

        // æ˜¾ç¤ºæç¤ºï¼ˆå‚è€ƒstudy.htmlçš„é€»è¾‘ï¼‰
        function showHint() {
            // ä¼˜å…ˆæç¤ºé”™è¯¯çš„ï¼Œå†æç¤ºç©ºç™½çš„
            let inputs = document.querySelectorAll('.blank-input.incorrect');
            if (inputs.length === 0) {
                inputs = document.querySelectorAll('.blank-input:not(.correct):not(.incorrect)');
            }
            
            if (inputs.length > 0) {
                const randomInput = inputs[0]; // å–ç¬¬ä¸€ä¸ªéœ€è¦æç¤ºçš„
                randomInput.value = randomInput.dataset.answer;
                randomInput.classList.remove('incorrect');
                randomInput.classList.add('correct');
                
                // ç§»é™¤è¯¥è¾“å…¥æ¡†çš„é”™è¯¯ç­”æ¡ˆæ˜¾ç¤ºï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
                const correctAnswerSpan = randomInput.parentElement.querySelector('.correct-answer');
                if (correctAnswerSpan) {
                    correctAnswerSpan.remove();
                }
                
                console.log('æç¤ºç­”æ¡ˆ:', randomInput.dataset.answer);
                
                // æ˜¾ç¤ºæç¤ºåé¦ˆ
                const resultHTML = document.getElementById('verseReference');
                if (!resultHTML.innerHTML.includes('ğŸ’¡ å·²æç¤º')) {
                    resultHTML.innerHTML += '<br><span style="color: #f39c12; font-size: 0.9em;">ğŸ’¡ å·²æç¤ºä¸€ä¸ªç­”æ¡ˆ</span>';
                }
            } else {
                alert('æ‰€æœ‰ç­”æ¡ˆéƒ½å·²æ­£ç¡®ï¼');
            }
        }

        // æ›´æ–°è¿›åº¦
        function updateProgress() {
            const progress = ((currentVerseIndex + 1) / totalQuestions) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('scoreDisplay').textContent = `ç¬¬ ${currentVerseIndex + 1} é¢˜ / å…± ${totalQuestions} é¢˜ | å¾—åˆ†: ${score}`;
        }

        // ä¸‹ä¸€ç»„ï¼ˆ5èŠ‚ï¼‰
        function nextVerse() {
            currentVerseIndex += 5;  // æ¯æ¬¡è·³è½¬5èŠ‚
            if (currentVerseIndex >= currentVerses.length) {
                showResults();
            } else {
                displayCurrentVerse();
            }
        }

        // æ˜¾ç¤ºç»“æœ
        function showResults() {
            const endTime = Date.now();
            const timeSpent = Math.floor((endTime - startTime) / 1000);
            
            // ç¡®ä¿å‡†ç¡®ç‡è®¡ç®—æ­£ç¡®
            const accuracy = totalQuestions > 0 ? Math.round((correctAnswers / totalQuestions) * 100) : 0;
            
            console.log('ç»ƒä¹ ç»“æœ:', {
                correctAnswers: correctAnswers,
                totalQuestions: totalQuestions,
                accuracy: accuracy
            });
            
            document.getElementById('practiceArea').style.display = 'none';
            document.getElementById('progressInfo').style.display = 'none';
            document.getElementById('resultsPanel').style.display = 'block';
            
            document.getElementById('totalAnswered').textContent = totalQuestions;
            document.getElementById('correctAnswers').textContent = correctAnswers;
            document.getElementById('accuracyRate').textContent = accuracy + '%';
            document.getElementById('timeSpent').textContent = timeSpent + 'ç§’';
            
            // ä¿å­˜æˆç»©
            saveProgress(accuracy);
        }

        // ä¿å­˜è¿›åº¦
        function saveProgress(accuracy) {
            let userProgress = JSON.parse(localStorage.getItem('userProgress')) || {
                practices: 0,
                accuracy: 0,
                streakDays: 1,
                totalDays: 1,
                chaptersRead: 1
            };
            
            // ç¡®ä¿å‡†ç¡®ç‡åœ¨åˆç†èŒƒå›´å†…
            accuracy = Math.max(0, Math.min(100, accuracy || 0));
            
            userProgress.practices++;
            
            // ä¿®å¤å‡†ç¡®ç‡è®¡ç®—é€»è¾‘
            if (userProgress.practices === 1) {
                // ç¬¬ä¸€æ¬¡ç»ƒä¹ ï¼Œç›´æ¥ä½¿ç”¨å½“å‰å‡†ç¡®ç‡
                userProgress.accuracy = accuracy;
            } else {
                // è®¡ç®—å¹³å‡å‡†ç¡®ç‡
                const totalAccuracy = userProgress.accuracy * (userProgress.practices - 1) + accuracy;
                userProgress.accuracy = Math.round(totalAccuracy / userProgress.practices);
            }
            
            // ç¡®ä¿æœ€ç»ˆå‡†ç¡®ç‡åœ¨0-100èŒƒå›´å†…
            userProgress.accuracy = Math.max(0, Math.min(100, userProgress.accuracy));
            
            console.log('ä¿å­˜è¿›åº¦:', {
                practices: userProgress.practices,
                currentAccuracy: accuracy,
                averageAccuracy: userProgress.accuracy
            });
            
            localStorage.setItem('userProgress', JSON.stringify(userProgress));
        }

        // é‡æ–°å¼€å§‹ç»ƒä¹ 
        function restartPractice() {
            document.getElementById('resultsPanel').style.display = 'none';
            document.getElementById('settingsPanel').style.display = 'block';
            document.getElementById('progressInfo').style.display = 'none';
        }

        // è¿”å›é¦–é¡µ
        function goHome() {
            window.location.href = 'index.html';
        }
        
        // è¿”å›ä¹¦å·é€‰æ‹©é¡µé¢
        function goBackToBookSelection() {
            // éšè—æ‰€æœ‰å±å¹•
            document.getElementById('exerciseScreen').style.display = 'none';
            document.getElementById('resultScreen').style.display = 'none';
            document.getElementById('chapterSelectionStep').style.display = 'none';
            
            // æ˜¾ç¤ºä¹¦å·é€‰æ‹©é¡µé¢
            document.getElementById('bookSelectionStep').style.display = 'block';
            
            // æ¸…ç†é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.book-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // é‡ç½®å˜é‡
            selectedBook = '';
            currentBook = '';
            selectedChapter = 1;
            currentChapter = 1;
        }

        // å·¥å…·å‡½æ•°ï¼šæ•°ç»„æ´—ç‰Œ
        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }
        
        // æ‰“å¼€ç»æ–‡æ ¡å¯¹å·¥å…·
        function openVerseEditor() {
            console.log('å¼€å§‹æ‰“å¼€ç»æ–‡æ ¡å¯¹å·¥å…·...');
            
            try {
                // å°è¯•åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€
                const newWindow = window.open('verse_editor.html', '_blank');
                
                // æ£€æŸ¥æ˜¯å¦è¢«å¼¹çª—æ‹¦æˆªå™¨é˜»æ­¢
                setTimeout(() => {
                    if (!newWindow || newWindow.closed || typeof newWindow.closed == 'undefined') {
                        console.log('å¼¹çª—è¢«é˜»æ­¢ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ');
                        if (confirm('ğŸ”’ æµè§ˆå™¨é˜»æ­¢äº†å¼¹çª—\n\næ˜¯å¦ç›´æ¥è·³è½¬åˆ°ç»æ–‡æ ¡å¯¹å·¥å…·ï¼Ÿ\nï¼ˆå»ºè®®å…è®¸æ­¤ç½‘ç«™çš„å¼¹çª—ä»¥è·å¾—æ›´å¥½ä½“éªŒï¼‰')) {
                            window.location.href = 'verse_editor.html';
                        }
                    } else {
                        console.log('æˆåŠŸåœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€æ ¡å¯¹å·¥å…·');
                        newWindow.focus();
                    }
                }, 100);
                
            } catch (error) {
                console.error('æ‰“å¼€æ ¡å¯¹å·¥å…·å¤±è´¥:', error);
                // å¤‡ç”¨æ–¹æ¡ˆï¼šç›´æ¥è·³è½¬
                window.location.href = 'verse_editor.html';
            }
        }
        
        // ç¼–è¾‘ç»æ–‡å‡½æ•°
        function editVerse(verseId, originalText, bookName, chapter, verse) {
            console.log('editVerseè¢«è°ƒç”¨:', {verseId, originalText, bookName, chapter, verse});
            
            try {
                const newText = prompt(`ç¼–è¾‘ç»æ–‡ ${bookName} ${chapter}:${verse}\n\nè¯·è¾“å…¥æ­£ç¡®çš„ç»æ–‡å†…å®¹ï¼š`, originalText);
                console.log('ç”¨æˆ·è¾“å…¥çš„æ–°ç»æ–‡:', newText);
                
                if (newText && newText.trim() !== originalText.trim()) {
                // æ›´æ–°å½“å‰æ˜¾ç¤º
                const verseGroup = document.querySelector(`[data-verse-id="${verseId}"]`);
                if (verseGroup) {
                    const verseTextDiv = verseGroup.querySelector('.verse-text');
                    verseTextDiv.dataset.original = newText;
                    
                    // é‡æ–°ç”Ÿæˆå¡«ç©º
                    const blankedText = createBlankedVerse(newText);
                    verseTextDiv.innerHTML = blankedText;
                    
                    // é‡æ–°ç»‘å®šè¾“å…¥äº‹ä»¶
                    addInputEventListeners();
                }
                
                // ä¿å­˜åˆ°æœåŠ¡å™¨
                saveVerseEdit(currentBook, chapter, verse, newText);
                
                // æ›´æ–°å†…å­˜ä¸­çš„æ•°æ®
                const verseIndex = currentVerses.findIndex(v => v.chapter == chapter && v.verse == verse);
                if (verseIndex !== -1) {
                    currentVerses[verseIndex].text = newText;
                    currentVerses[verseIndex].zh = newText;
                }
                
                    console.log(`ç»æ–‡å·²ä¿®æ”¹: ${bookName} ${chapter}:${verse}`);
                    alert('âœ… ç»æ–‡å·²æ›´æ–°å¹¶ä¿å­˜ï¼');
                }
            } catch (error) {
                console.error('ç¼–è¾‘ç»æ–‡æ—¶å‘ç”Ÿé”™è¯¯:', error);
                alert('âŒ ç¼–è¾‘ç»æ–‡æ—¶å‘ç”Ÿé”™è¯¯ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°');
            }
        }
        
        // ä¿å­˜ç»æ–‡ä¿®æ”¹åˆ°æœåŠ¡å™¨
        async function saveVerseEdit(book, chapter, verse, newText) {
            try {
                const response = await fetch('/api/save-verse', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        book: book,
                        chapter: chapter,
                        verse: verse,
                        text: newText
                    })
                });
                
                if (!response.ok) {
                    throw new Error('ä¿å­˜å¤±è´¥');
                }
                
                console.log('ç»æ–‡ä¿å­˜æˆåŠŸ');
            } catch (error) {
                console.error('ä¿å­˜ç»æ–‡å¤±è´¥:', error);
                alert('âš ï¸ ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–è”ç³»ç®¡ç†å‘˜');
            }
        }
    </script>
</body>
</html>