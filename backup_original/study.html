<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">åœ£ç»å­¦ä¹  | Bible Study</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'PingFang SC', 'Microsoft YaHei', Arial, sans-serif;
            line-height: 1.6;
            background: linear-gradient(135deg, var(--primary-color, #667eea) 0%, var(--secondary-color, #764ba2) 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .header {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            padding: 15px 0;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }
        
        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }
        
        .book-info {
            color: white;
        }
        
        .book-title {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .book-subtitle {
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .nav-buttons {
            display: flex;
            gap: 15px;
        }
        
        .nav-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px 16px;
            border-radius: 20px;
            text-decoration: none;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }
        
        .nav-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }
        
        .container {
            max-width: calc(100% - 460px);
            margin: 0 auto 0 20px;
            padding: 20px;
        }
        
        .chapter-nav {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 10px;
            margin-bottom: 30px;
            padding: 25px;
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .chapter-btn {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            color: #495057;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            text-align: center;
        }
        
        .chapter-btn:hover {
            background: var(--primary-color, #667eea);
            color: white;
            border-color: var(--primary-color, #667eea);
            transform: translateY(-2px);
        }
        
        .chapter-btn.active {
            background: var(--primary-color, #667eea);
            color: white;
            border-color: var(--primary-color, #667eea);
        }
        
        .study-content {
            display: flex;
            height: calc(100vh - 160px); /* å‡å»å¤´éƒ¨é«˜åº¦ */
            gap: 20px;
            margin-bottom: 30px;
            position: relative;
        }
        
        .verses-section {
            flex: 1;
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow-y: auto;
            height: 100%;
        }
        
        .section-title {
            font-size: 1.8em;
            margin-bottom: 20px;
            color: #2c3e50;
            text-align: center;
            border-bottom: 2px solid var(--primary-color, #667eea);
            padding-bottom: 10px;
        }
        
        .verse-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .verse-table th {
            background: var(--primary-color, #667eea);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: bold;
        }
        
        .verse-table td {
            padding: 15px;
            border-bottom: 1px solid #eee;
            vertical-align: top;
        }
        
        .verse-table tr:hover {
            background: #f8f9fa;
        }
        
        .verse-number {
            font-weight: bold;
            color: var(--primary-color, #667eea);
            min-width: 40px;
        }
        
        .verse-text {
            line-height: 1.7;
        }
        
        .verse-zh {
            margin-bottom: 8px;
            font-size: 1.05em;
        }
        
        .verse-en {
            color: #666;
            font-style: italic;
        }
        
        .sidebar {
            width: 420px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            position: fixed;
            right: 20px;
            top: 160px;
            height: calc(100vh - 180px);
            z-index: 50;
        }
        
        .progress-card {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            flex-shrink: 0;
            max-height: 200px;
        }
        
        .fill-blank-card {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .progress-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .progress-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        
        .progress-item:last-child {
            border-bottom: none;
        }
        
        .verse-checkbox {
            margin-right: 10px;
            transform: scale(1.2);
            accent-color: var(--primary-color, #667eea);
        }
        
        .fill-blank-input {
            border: 1px solid var(--primary-color, #667eea);
            border-radius: 4px;
            background: rgba(52, 152, 219, 0.1);
            text-align: center;
            height: 32px;
            font-size: 1.1em;
            font-weight: 500;
            color: #2c3e50;
            padding: 4px 8px;
            margin: 0 2px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            box-sizing: border-box;
            display: inline-block;
            vertical-align: baseline;
        }
        
        .fill-blank-input:focus {
            outline: none;
            border-color: var(--secondary-color, #764ba2);
            background: rgba(52, 152, 219, 0.15);
            box-shadow: 0 0 5px rgba(52, 152, 219, 0.3);
        }
        
        .fill-blank-input.correct {
            background-color: #d5f4e6;
            border-color: #27ae60;
            color: #27ae60;
        }
        
        .fill-blank-input.incorrect {
            background-color: #fdeaea;
            border-color: #e74c3c;
            color: #e74c3c;
        }
        
        .fill-blank-input::placeholder {
            color: #bdc3c7;
            font-size: 0.9em;
            opacity: 0.7;
        }
        
        #fill-blank-content {
            flex: 1;
            overflow-y: auto;
            padding-right: 10px;
        }
        
        #fill-blank-content {
            flex: 1;
            overflow-y: auto;
            padding-right: 10px;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1200px) {
            .sidebar {
                width: 350px;
            }
        }
        
        @media (max-width: 768px) {
            .study-content {
                flex-direction: column;
                height: auto;
            }
            
            .sidebar {
                position: static;
                width: 100%;
                height: auto;
                right: auto;
                top: auto;
            }
            
            .verses-section {
                height: 60vh;
            }
        }
        
        .check-button {
            background: var(--primary-color, #667eea);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: all 0.3s ease;
            margin-top: 15px;
        }
        
        .check-button:hover {
            background: var(--secondary-color, #764ba2);
            transform: translateY(-2px);
        }
        
        #recheck-btn {
            background: linear-gradient(135deg, #f39c12, #e67e22) !important;
        }
        
        #recheck-btn:hover {
            background: linear-gradient(135deg, #e67e22, #f39c12) !important;
        }
        
        .exercise-btn {
            flex: 1;
            min-width: 80px;
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: bold;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        .preview-btn {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            color: white;
        }
        
        .preview-btn:hover {
            background: linear-gradient(135deg, #0984e3, #0056b3);
            transform: translateY(-2px);
        }
        
        .review-btn {
            background: linear-gradient(135deg, #fd79a8, #e84393);
            color: white;
        }
        
        .review-btn:hover {
            background: linear-gradient(135deg, #e84393, #d63384);
            transform: translateY(-2px);
        }
        
        .random-btn {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
        }
        
        .random-btn:hover {
            background: linear-gradient(135deg, #e67e22, #d35400);
            transform: translateY(-2px);
        }
        
        /* ç»æ–‡åŒºåŸŸæ»šåŠ¨æ¡æ ·å¼ */
        .verses-section::-webkit-scrollbar {
            width: 8px;
        }
        
        .verses-section::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.1);
            border-radius: 10px;
        }
        
        .verses-section::-webkit-scrollbar-thumb {
            background: var(--primary-color, #667eea);
            border-radius: 10px;
        }
        
        .verses-section::-webkit-scrollbar-thumb:hover {
            background: var(--secondary-color, #764ba2);
        }
        
        /* å¡«ç©ºå†…å®¹æ»šåŠ¨æ¡æ ·å¼ */
        #fill-blank-content::-webkit-scrollbar {
            width: 6px;
        }
        
        #fill-blank-content::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.1);
            border-radius: 10px;
        }
        
        #fill-blank-content::-webkit-scrollbar-thumb {
            background: #bdc3c7;
            border-radius: 10px;
        }
        
        #fill-blank-content::-webkit-scrollbar-thumb:hover {
            background: #95a5a6;
        }
        
        /* å›ºå®šä¾§è¾¹æ çš„è¿›å…¥åŠ¨ç”» */
        .sidebar {
            animation: slideInRight 0.5s ease-out;
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* ç»æ–‡åŒºåŸŸçš„æ·¡å…¥æ•ˆæœ */
        .verses-section {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1200px) {
            .sidebar {
                width: 350px;
            }
            
            .container {
                max-width: calc(100% - 390px);
            }
        }
        
        @media (max-width: 768px) {
            .study-content {
                flex-direction: column;
                height: auto;
            }
            
            .sidebar {
                position: static;
                width: 100%;
                height: auto;
                right: auto;
                top: auto;
            }
            
            .verses-section {
                height: 60vh;
            }
            
            .container {
                max-width: 100%;
                margin: 0 auto;
            }
        }
        
        /* ç»æ–‡åŒºåŸŸæ»šåŠ¨æ¡æ ·å¼ */
        .verses-section::-webkit-scrollbar {
            width: 8px;
        }
        
        .verses-section::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.1);
            border-radius: 10px;
        }
        
        .verses-section::-webkit-scrollbar-thumb {
            background: var(--primary-color, #667eea);
            border-radius: 10px;
        }
        
        .verses-section::-webkit-scrollbar-thumb:hover {
            background: var(--secondary-color, #764ba2);
        }
        
        /* å¡«ç©ºå†…å®¹æ»šåŠ¨æ¡æ ·å¼ */
        #fill-blank-content::-webkit-scrollbar {
            width: 6px;
        }
        
        #fill-blank-content::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.1);
            border-radius: 10px;
        }
        
        #fill-blank-content::-webkit-scrollbar-thumb {
            background: #bdc3c7;
            border-radius: 10px;
        }
        
        #fill-blank-content::-webkit-scrollbar-thumb:hover {
            background: #95a5a6;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            background: white;
            margin: 10% auto;
            padding: 30px;
            border-radius: 15px;
            width: 80%;
            max-width: 600px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .close {
            color: #999;
            float: right;
            font-size: 2em;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }
        
        .close:hover {
            color: #333;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            color: white;
            font-size: 1.2em;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #f5c6cb;
        }
        
        @media (max-width: 768px) {
            .study-content {
                grid-template-columns: 1fr;
            }
            
            .nav-container {
                flex-direction: column;
                gap: 15px;
            }
            
            .chapter-nav {
                grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
                gap: 8px;
                padding: 15px;
            }
            
            .book-title {
                font-size: 1.5em;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="nav-container">
            <div class="book-info">
                <div class="book-title" id="book-name">åŠ è½½ä¸­...</div>
                <div class="book-subtitle" id="book-description">Loading...</div>
            </div>
            <div class="nav-buttons">
                <a href="index.html" class="nav-btn">â† è¿”å›ä¸»é¡µ</a>
                <a href="#" class="nav-btn" onclick="window.print()">ğŸ“„ æ‰“å°</a>
            </div>
        </div>
    </div>

    <div class="container">
        <div id="loading" class="loading">æ­£åœ¨åŠ è½½åœ£ç»æ•°æ®...</div>
        <div id="error-message" class="error" style="display: none;"></div>
        
        <div id="main-content" style="display: none;">
            <div class="chapter-nav" id="chapter-nav">
                <!-- ç« èŠ‚å¯¼èˆªå°†åŠ¨æ€ç”Ÿæˆ -->
            </div>

            <div class="study-content">
                <div class="verses-section">
                    <h2 class="section-title">
                        <span id="current-chapter-title">ç¬¬1ç«  ç»æ–‡å­¦ä¹ </span>
                    </h2>
                    <div id="verses-container">
                        <table class="verse-table">
                            <thead>
                                <tr>
                                    <th style="width: 60px;">èŠ‚</th>
                                    <th>ç»æ–‡ (å’Œåˆæœ¬ + NIV)</th>
                                    <th style="width: 60px;">âœ“</th>
                                </tr>
                            </thead>
                            <tbody id="verses-tbody">
                                <!-- ç»æ–‡å†…å®¹å°†åŠ¨æ€åŠ è½½ -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="sidebar">
                    <div class="progress-card">
                        <h3 class="section-title" style="font-size: 1.3em;">å­¦ä¹ è¿›åº¦</h3>
                        <div id="progress-summary">
                            <p>å½“å‰ç« èŠ‚: <span id="current-progress">0/0</span></p>
                            <p>æ€»ä½“è¿›åº¦: <span id="total-progress">0/0</span></p>
                        </div>
                    </div>

                    <div class="fill-blank-card">
                        <h3 class="section-title" style="font-size: 1.3em;">å¡«ç©ºç»ƒä¹  
                            <small style="font-size: 0.6em; color: #7f8c8d; font-weight: normal;">ğŸ“– å¯è¾¹çœ‹ç»æ–‡è¾¹ç»ƒä¹ </small>
                        </h3>
                        <div class="exercise-buttons" style="margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="exercise-btn preview-btn" onclick="generateFillBlank('preview')" title="ä¼˜å…ˆé€‰æ‹©æœªæ‰“å¡çš„ç»æ–‡è¿›è¡Œé¢„ä¹ ">
                                ğŸ“š é¢„ä¹ 
                            </button>
                            <button class="exercise-btn review-btn" onclick="generateFillBlank('review')" title="å¤ä¹ å·²æ‰“å¡çš„ç»æ–‡">
                                ğŸ”„ å¤ä¹ 
                            </button>
                            <button class="exercise-btn random-btn" onclick="generateFillBlank('random')" title="ä»é‡‘å¥ä¸­éšæœºé€‰æ‹©ç»ƒä¹ ">
                                âœ¨ é‡‘å¥
                            </button>
                        </div>
                        <div id="fill-blank-content">
                            <p style="text-align: center; color: #7f8c8d; margin: 20px 0;">
                                é€‰æ‹©ç»ƒä¹ æ¨¡å¼å¼€å§‹å­¦ä¹ <br>
                                <small>ğŸ“šé¢„ä¹ : æœªæ‰“å‹¾ç»æ–‡ | ğŸ”„å¤ä¹ : å·²æ‰“å‹¾ç»æ–‡ | âœ¨é‡‘å¥: é‡è¦ç»æ–‡ç»ƒä¹ </small>
                            </p>
                        </div>
                        <div id="fill-result" style="margin-top: 15px; font-weight: bold;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- èƒŒæ™¯ä¿¡æ¯æ¨¡æ€æ¡† -->
    <div id="background-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3 id="modal-title">ç»æ–‡èƒŒæ™¯</h3>
            <div id="modal-body"></div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentBook = null;
        let bookData = null;
        let currentChapter = 1;
        let progressData = {};
        
        // ç»ƒä¹ çŠ¶æ€è·Ÿè¸ª
        let currentExerciseMode = null;
        let exercisedVerses = new Set(); // å·²ç»ƒä¹ è¿‡çš„ç»æ–‡
        let currentExerciseVerse = null; // å½“å‰ç»ƒä¹ çš„ç»æ–‡

        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const bookId = urlParams.get('book');
            
            if (!bookId) {
                showError('æœªæŒ‡å®šä¹¦å·å‚æ•°ï¼Œæ­£åœ¨è·³è½¬åˆ°ä¸»é¡µ...');
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);
                return;
            }
            
            await loadBookData(bookId);
        });

        // åŠ è½½ä¹¦å·æ•°æ®
        async function loadBookData(bookId) {
            try {
                const response = await fetch(`data/${bookId}.json`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                bookData = await response.json();
                currentBook = bookId;
                
                // è®¾ç½®é¡µé¢ä¸»é¢˜è‰²
                document.documentElement.style.setProperty('--primary-color', bookData.color);
                document.documentElement.style.setProperty('--secondary-color', adjustColor(bookData.color, -20));
                
                // æ›´æ–°é¡µé¢ä¿¡æ¯
                document.getElementById('page-title').textContent = `${bookData.name} - åœ£ç»äº’åŠ¨å­¦ä¹ `;
                document.getElementById('book-name').textContent = `${bookData.name} ${bookData.englishName}`;
                document.getElementById('book-description').textContent = bookData.description;
                
                // æ¸²æŸ“ç•Œé¢
                renderChapterNav();
                loadProgress();
                changeChapter(1);
                
                // éšè—åŠ è½½æç¤ºï¼Œæ˜¾ç¤ºä¸»å†…å®¹
                document.getElementById('loading').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';
                
            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                showError(`åŠ è½½ ${bookId} æ•°æ®å¤±è´¥: ${error.message}`);
            }
        }

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error-message').textContent = message;
            document.getElementById('error-message').style.display = 'block';
        }

        // è°ƒæ•´é¢œè‰²äº®åº¦
        function adjustColor(color, amount) {
            const num = parseInt(color.replace("#",""), 16);
            const amt = Math.round(2.55 * amount);
            const R = (num >> 16) + amt;
            const G = (num >> 8 & 0x00FF) + amt;
            const B = (num & 0x0000FF) + amt;
            return "#" + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
                (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
                (B < 255 ? B < 1 ? 0 : B : 255)).toString(16).slice(1);
        }

        // æ¸²æŸ“ç« èŠ‚å¯¼èˆª
        function renderChapterNav() {
            const nav = document.getElementById('chapter-nav');
            nav.innerHTML = '';
            
            for (let i = 1; i <= bookData.chapters; i++) {
                const btn = document.createElement('button');
                btn.className = 'chapter-btn';
                btn.textContent = i;
                btn.onclick = () => changeChapter(i);
                nav.appendChild(btn);
            }
        }

        // åˆ‡æ¢ç« èŠ‚
        function changeChapter(chapterNum) {
            currentChapter = chapterNum;
            
            // é‡ç½®ç»ƒä¹ çŠ¶æ€
            exercisedVerses.clear();
            currentExerciseVerse = null;
            currentExerciseMode = null;
            
            // é‡ç½®å¡«ç©ºç»ƒä¹ å†…å®¹
            document.getElementById('fill-blank-content').innerHTML = `
                <p style="text-align: center; color: #7f8c8d; margin: 20px 0;">
                    é€‰æ‹©ç»ƒä¹ æ¨¡å¼å¼€å§‹å­¦ä¹ <br>
                    <small>ğŸ“šé¢„ä¹ : æœªæ‰“å‹¾ç»æ–‡ | ğŸ”„å¤ä¹ : å·²æ‰“å‹¾ç»æ–‡ | âœ¨é‡‘å¥: é‡è¦ç»æ–‡ç»ƒä¹ </small>
                </p>
            `;
            
            // æ›´æ–°å¯¼èˆªæŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.chapter-btn').forEach((btn, index) => {
                btn.classList.toggle('active', index + 1 === chapterNum);
            });
            
            // æ›´æ–°ç« èŠ‚æ ‡é¢˜
            document.getElementById('current-chapter-title').textContent = `ç¬¬${chapterNum}ç«  ç»æ–‡å­¦ä¹ `;
            
            // æ¸²æŸ“ç»æ–‡å’Œå…¶ä»–å†…å®¹
            renderVerses();
            renderKeyVerses();
            updateProgressSummary();
        }

        // æ¸²æŸ“ç»æ–‡
        function renderVerses() {
            const tbody = document.getElementById('verses-tbody');
            tbody.innerHTML = '';
            
            const chapterVerses = bookData.verses.filter(v => v.chapter === currentChapter);
            
            chapterVerses.forEach(verse => {
                const row = document.createElement('tr');
                row.setAttribute('data-chapter', verse.chapter);
                row.setAttribute('data-verse', verse.verse);
                
                // ç»æ–‡èŠ‚æ•°
                const verseCell = document.createElement('td');
                verseCell.className = 'verse-number';
                verseCell.textContent = verse.verse;
                
                // ç»æ–‡å†…å®¹
                const textCell = document.createElement('td');
                textCell.className = 'verse-text';
                
                const zhDiv = document.createElement('div');
                zhDiv.className = 'verse-zh';
                zhDiv.textContent = verse.zh;
                
                const enDiv = document.createElement('div');
                enDiv.className = 'verse-en';
                enDiv.textContent = verse.en;
                
                textCell.appendChild(zhDiv);
                textCell.appendChild(enDiv);
                
                // æ·»åŠ èƒŒæ™¯ä¿¡æ¯æŒ‰é’®
                if (verse.background) {
                    const bgBtn = document.createElement('button');
                    bgBtn.textContent = 'ğŸ“–';
                    bgBtn.style.cssText = 'margin-left: 10px; background: none; border: 1px solid #ddd; border-radius: 50%; width: 30px; height: 30px; cursor: pointer;';
                    bgBtn.onclick = () => showBackground(verse);
                    textCell.appendChild(bgBtn);
                }
                
                // å¤é€‰æ¡†
                const checkCell = document.createElement('td');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'verse-checkbox';
                checkbox.id = `check-${currentChapter}-${verse.verse}`;
                checkbox.onchange = () => saveProgress(currentChapter, verse.verse);
                
                // ä»æœ¬åœ°å­˜å‚¨æ¢å¤çŠ¶æ€
                const key = `${currentBook}-${currentChapter}-${verse.verse}`;
                checkbox.checked = progressData[key] || false;
                
                checkCell.appendChild(checkbox);
                
                row.appendChild(verseCell);
                row.appendChild(textCell);
                row.appendChild(checkCell);
                tbody.appendChild(row);
            });
        }

        // æ¸²æŸ“é‡‘å¥ç»ƒä¹ 
        function renderKeyVerses() {
            const keyVersesOfChapter = bookData.keyVerses.filter(kv => kv.chapter === currentChapter);
            
            if (keyVersesOfChapter.length === 0) {
                document.getElementById('fill-blank-content').innerHTML = '<p>æœ¬ç« æš‚æ— å¡«ç©ºç»ƒä¹ </p>';
                return;
            }
        }

        // è®¡ç®—è¾“å…¥æ¡†å®½åº¦çš„è¾…åŠ©å‡½æ•°
        function calculateInputWidth(text) {
            // ä¼˜åŒ–åŸºç¡€å®½åº¦ï¼Œé˜²æ­¢è¿‡å®½å¯¼è‡´æ¢è¡Œ
            const baseWidth = 30;
            // å‡å°æ¯ä¸ªå­—ç¬¦çš„å®½åº¦ï¼Œä½¿è¾“å…¥æ¡†æ›´ç´§å‡‘
            let totalWidth = baseWidth;
            
            for (let char of text) {
                if (/[\u4e00-\u9fa5]/.test(char)) {
                    // ä¸­æ–‡å­—ç¬¦
                    totalWidth += 16;
                } else if (/[a-zA-Z0-9]/.test(char)) {
                    // è‹±æ–‡å­—ç¬¦å’Œæ•°å­—
                    totalWidth += 10;
                } else {
                    // å…¶ä»–å­—ç¬¦ï¼ˆæ ‡ç‚¹ç¬¦å·ç­‰ï¼‰
                    totalWidth += 8;
                }
            }
            
            // è®¾ç½®åˆç†çš„å®½åº¦èŒƒå›´ï¼Œé˜²æ­¢è¿‡å®½
            return Math.max(40, Math.min(totalWidth + 15, 120));
        }
        
        // æ›´æ–°ç»ƒä¹ æŒ‰é’®çŠ¶æ€
        function updateExerciseButtonsState() {
            // è·å–å½“å‰ç« èŠ‚æ‰€æœ‰ç»æ–‡
            const allVersesInChapter = bookData.verses.filter(v => v.chapter === currentChapter);
            const keyVersesOfChapter = bookData.keyVerses.filter(kv => kv.chapter === currentChapter);
            
            // è®¡ç®—æœªæ‰“å‹¾ä¸”æœªç»ƒä¹ çš„ç»æ–‡æ•°é‡ï¼ˆé¢„ä¹ ç”¨ï¼‰
            const uncheckedAndUnexercisedVerses = allVersesInChapter.filter(v => {
                const key = `${currentBook}-${v.chapter}-${v.verse}`;
                const verseKey = `${v.chapter}:${v.verse}`;
                return !progressData[key] && !exercisedVerses.has(verseKey);
            }).length;
            
            // è®¡ç®—å·²æ‰“å‹¾ä¸”æœªç»ƒä¹ çš„ç»æ–‡æ•°é‡ï¼ˆå¤ä¹ ç”¨ï¼‰
            const checkedAndUnexercisedVerses = allVersesInChapter.filter(v => {
                const key = `${currentBook}-${v.chapter}-${v.verse}`;
                const verseKey = `${v.chapter}:${v.verse}`;
                return progressData[key] && !exercisedVerses.has(verseKey);
            }).length;
            
            // è®¡ç®—æœªç»ƒä¹ çš„é‡‘å¥æ•°é‡
            const unexercisedKeyVerses = keyVersesOfChapter.filter(kv => {
                const verseKey = `${kv.chapter}:${kv.verse}`;
                return !exercisedVerses.has(verseKey);
            }).length;
            
            const previewBtn = document.querySelector('.preview-btn');
            const reviewBtn = document.querySelector('.review-btn');
            const randomBtn = document.querySelector('.random-btn');
            
            if (previewBtn && reviewBtn && randomBtn) {
                // æ›´æ–°æŒ‰é’®æ–‡æœ¬æ˜¾ç¤ºå‰©ä½™å¯ç»ƒä¹ æ•°é‡
                previewBtn.innerHTML = `ğŸ“š é¢„ä¹  <small>(${uncheckedAndUnexercisedVerses})</small>`;
                reviewBtn.innerHTML = `ğŸ”„ å¤ä¹  <small>(${checkedAndUnexercisedVerses})</small>`;
                randomBtn.innerHTML = `âœ¨ é‡‘å¥ <small>(${unexercisedKeyVerses})</small>`;
                
                // è®¾ç½®æŒ‰é’®çš„å¯ç”¨çŠ¶æ€
                previewBtn.disabled = uncheckedAndUnexercisedVerses === 0;
                reviewBtn.disabled = checkedAndUnexercisedVerses === 0;
                randomBtn.disabled = unexercisedKeyVerses === 0;
                
                // æ·»åŠ ç¦ç”¨çŠ¶æ€çš„æ ·å¼
                if (uncheckedAndUnexercisedVerses === 0) {
                    previewBtn.style.opacity = '0.5';
                    previewBtn.style.cursor = 'not-allowed';
                } else {
                    previewBtn.style.opacity = '1';
                    previewBtn.style.cursor = 'pointer';
                }
                
                if (checkedAndUnexercisedVerses === 0) {
                    reviewBtn.style.opacity = '0.5';
                    reviewBtn.style.cursor = 'not-allowed';
                } else {
                    reviewBtn.style.opacity = '1';
                    reviewBtn.style.cursor = 'pointer';
                }
                
                if (unexercisedKeyVerses === 0) {
                    randomBtn.style.opacity = '0.5';
                    randomBtn.style.cursor = 'not-allowed';
                } else {
                    randomBtn.style.opacity = '1';
                    randomBtn.style.cursor = 'pointer';
                }
            }
        }
        
        // æ ¹æ®ç»ƒä¹ æ¨¡å¼é€‰æ‹©ç»æ–‡ï¼ˆä¸é‡å¤ï¼‰
        function selectVerseByMode(keyVersesOfChapter, mode) {
            
            if (mode === 'preview') {
                // é¢„ä¹ æ¨¡å¼ï¼šä»æ‰€æœ‰æœªæ‰“å‹¾ä¸”æœªç»ƒä¹ è¿‡çš„ç»æ–‡ä¸­é€‰æ‹©
                const allVersesInChapter = bookData.verses.filter(v => v.chapter === currentChapter);
                const uncheckedAndUnexercisedVerses = allVersesInChapter.filter(v => {
                    const key = `${currentBook}-${v.chapter}-${v.verse}`;
                    const verseKey = `${v.chapter}:${v.verse}`;
                    return !progressData[key] && !exercisedVerses.has(verseKey);
                });
                
                if (uncheckedAndUnexercisedVerses.length === 0) {
                    return null; // æ²¡æœ‰å¯é¢„ä¹ çš„ç»æ–‡
                }
                
                const randomVerse = uncheckedAndUnexercisedVerses[Math.floor(Math.random() * uncheckedAndUnexercisedVerses.length)];
                return {
                    chapter: randomVerse.chapter,
                    verse: randomVerse.verse
                };
                
            } else if (mode === 'review') {
                // å¤ä¹ æ¨¡å¼ï¼šä»æ‰€æœ‰å·²æ‰“å‹¾ä¸”æœªç»ƒä¹ è¿‡çš„ç»æ–‡ä¸­é€‰æ‹©
                const allVersesInChapter = bookData.verses.filter(v => v.chapter === currentChapter);
                const checkedAndUnexercisedVerses = allVersesInChapter.filter(v => {
                    const key = `${currentBook}-${v.chapter}-${v.verse}`;
                    const verseKey = `${v.chapter}:${v.verse}`;
                    return progressData[key] && !exercisedVerses.has(verseKey);
                });
                
                if (checkedAndUnexercisedVerses.length === 0) {
                    return null; // æ²¡æœ‰å¯å¤ä¹ çš„ç»æ–‡
                }
                
                const randomVerse = checkedAndUnexercisedVerses[Math.floor(Math.random() * checkedAndUnexercisedVerses.length)];
                return {
                    chapter: randomVerse.chapter,
                    verse: randomVerse.verse
                };
                
            } else {
                // é‡‘å¥æ¨¡å¼ï¼šä»æœªç»ƒä¹ è¿‡çš„é‡‘å¥ä¸­é€‰æ‹©
                const unexercisedKeyVerses = keyVersesOfChapter.filter(kv => {
                    const verseKey = `${kv.chapter}:${kv.verse}`;
                    return !exercisedVerses.has(verseKey);
                });
                
                if (unexercisedKeyVerses.length === 0) {
                    return null; // æ²¡æœ‰å¯ç»ƒä¹ çš„é‡‘å¥
                }
                
                return unexercisedKeyVerses[Math.floor(Math.random() * unexercisedKeyVerses.length)];
            }
        }
        
        // å¤„ç†ç»ƒä¹ å®Œæˆçš„æƒ…å†µ
        function handleExerciseCompletion(mode) {
            let message = '';
            let buttons = '';
            
            if (mode === 'preview') {
                // é¢„ä¹ å®Œæˆï¼Œè¯¢é—®æ˜¯å¦å¤ä¹ 
                const allVersesInChapter = bookData.verses.filter(v => v.chapter === currentChapter);
                const checkedVerses = allVersesInChapter.filter(v => {
                    const key = `${currentBook}-${v.chapter}-${v.verse}`;
                    return progressData[key];
                }).length;
                
                if (checkedVerses > 0) {
                    message = `
                        <div style="text-align: center; padding: 20px;">
                            <h3 style="color: #27ae60;">ğŸ‰ é¢„ä¹ å®Œæˆï¼</h3>
                            <p style="color: #7f8c8d; margin: 15px 0;">
                                æ­å–œï¼æœ¬ç« æ‰€æœ‰æœªæ‰“å‹¾çš„ç»æ–‡éƒ½å·²é¢„ä¹ å®Œæ¯•ã€‚<br>
                                ç°åœ¨æœ‰ <strong>${checkedVerses}</strong> æ¡ç»æ–‡å¯ä»¥å¤ä¹ ï¼Œæ˜¯å¦å¼€å§‹å¤ä¹ ï¼Ÿ
                            </p>
                        </div>
                    `;
                    buttons = `
                        <div style="display: flex; gap: 10px; justify-content: center; margin-top: 15px;">
                            <button class="check-button" onclick="startReview()" style="background: #fd79a8;">å¼€å§‹å¤ä¹ </button>
                            <button class="check-button" onclick="resetExercise()" style="background: #74b9ff;">é‡æ–°é¢„ä¹ </button>
                        </div>
                    `;
                } else {
                    message = `
                        <div style="text-align: center; padding: 20px;">
                            <h3 style="color: #27ae60;">ğŸ‰ é¢„ä¹ å®Œæˆï¼</h3>
                            <p style="color: #7f8c8d; margin: 15px 0;">
                                æ­å–œï¼æœ¬ç« æ‰€æœ‰ç»æ–‡éƒ½å·²é¢„ä¹ å®Œæ¯•ï¼Œä½†è¿˜æ²¡æœ‰æ‰“å‹¾çš„ç»æ–‡å¯ä¾›å¤ä¹ ã€‚
                            </p>
                        </div>
                    `;
                    buttons = `
                        <div style="display: flex; gap: 10px; justify-content: center; margin-top: 15px;">
                            <button class="check-button" onclick="resetExercise()" style="background: #74b9ff;">é‡æ–°å¼€å§‹</button>
                        </div>
                    `;
                }
            } else if (mode === 'review') {
                // å¤ä¹ å®Œæˆï¼Œè¯¢é—®æ˜¯å¦é‡æ–°å¼€å§‹
                message = `
                    <div style="text-align: center; padding: 20px;">
                        <h3 style="color: #fd79a8;">ğŸ”„ å¤ä¹ å®Œæˆï¼</h3>
                        <p style="color: #7f8c8d; margin: 15px 0;">
                            æ­å–œï¼æœ¬ç« æ‰€æœ‰å·²æ‰“å‹¾çš„ç»æ–‡éƒ½å·²å¤ä¹ å®Œæ¯•ã€‚<br>
                            æ˜¯å¦è¦é‡æ–°å¼€å§‹å¤ä¹ ï¼Ÿ
                        </p>
                    </div>
                `;
                buttons = `
                    <div style="display: flex; gap: 10px; justify-content: center; margin-top: 15px;">
                        <button class="check-button" onclick="resetExercise()" style="background: #fd79a8;">é‡æ–°å¤ä¹ </button>
                        <button class="check-button" onclick="startPreview()" style="background: #74b9ff;">è½¬åˆ°é¢„ä¹ </button>
                    </div>
                `;
            } else {
                // é‡‘å¥ç»ƒä¹ å®Œæˆ
                message = `
                    <div style="text-align: center; padding: 20px;">
                        <h3 style="color: #f39c12;">âœ¨ é‡‘å¥ç»ƒä¹ å®Œæˆï¼</h3>
                        <p style="color: #7f8c8d; margin: 15px 0;">
                            æ­å–œï¼æœ¬ç« æ‰€æœ‰é‡‘å¥éƒ½å·²ç»ƒä¹ å®Œæ¯•ã€‚<br>
                            æ˜¯å¦è¦é‡æ–°å¼€å§‹é‡‘å¥ç»ƒä¹ ï¼Ÿ
                        </p>
                    </div>
                `;
                buttons = `
                    <div style="display: flex; gap: 10px; justify-content: center; margin-top: 15px;">
                        <button class="check-button" onclick="resetExercise()" style="background: #f39c12;">é‡æ–°ç»ƒä¹ </button>
                        <button class="check-button" onclick="startPreview()" style="background: #74b9ff;">è½¬åˆ°é¢„ä¹ </button>
                    </div>
                `;
            }
            
            document.getElementById('fill-blank-content').innerHTML = message + buttons;
        }
        
        // å¼€å§‹å¤ä¹ æ¨¡å¼
        function startReview() {
            exercisedVerses.clear();
            currentExerciseVerse = null;
            generateFillBlank('review');
        }
        
        // å¼€å§‹é¢„ä¹ æ¨¡å¼
        function startPreview() {
            exercisedVerses.clear();
            currentExerciseVerse = null;
            generateFillBlank('preview');
        }
        
        // é‡ç½®ç»ƒä¹ çŠ¶æ€
        function resetExercise() {
            exercisedVerses.clear();
            currentExerciseVerse = null;
            generateFillBlank(currentExerciseMode);
        }
        
        // æå–æœ‰æ„ä¹‰çš„è¯è¯­ï¼ˆ2-7å­—çš„å®Œæ•´è¯ç»„ï¼‰
        function extractMeaningfulWords(text) {
            const meaningfulWords = [];
            
            // é«˜ä¼˜å…ˆçº§è¯ç»„æ¨¡å¼ï¼ˆ2-7å­—ï¼‰
            const phrasePatterns = [
                // ç¥å­¦æ¦‚å¿µè¯ç»„ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
                'ä¸Šå¸çš„å„¿å¥³', 'ç¥çš„å›½åº¦', 'è€¶ç¨£åŸºç£', 'åœ£çµå……æ»¡', 'æ•‘ä¸»è€¶ç¨£', 'å¤©çˆ¶ä¸Šå¸',
                'åŸºç£çš„èº«ä½“', 'ç¥çš„æ—¨æ„', 'ä¸»çš„å‘½ä»¤', 'åœ£çµçš„æœå­', 'ç¥çš„æ©å…¸', 'ä¸»çš„é“è·¯',
                'æ°¸ç”Ÿç¥çš„', 'åˆ›é€ ä¸‡ç‰©', 'å…¨èƒ½çš„ç¥', 'ä¸‡ç‰©çš„ä¸»', 'è£è€€çš„ç‹',
                
                // å±çµå“è´¨å’ŒçŠ¶æ€
                'åœ£æ´æ— ç‘•', 'å…¬ä¹‰å’Œå¹³', 'æ…ˆçˆ±å’ŒçœŸç†', 'æ©å…¸å’ŒçœŸç†', 'ä¿¡æœ›å’Œçˆ±',
                'å¹³å®‰å’Œå–œä¹', 'è°¦å‘å’Œæ¸©æŸ”', 'è‰¯å–„å’Œå¿è€', 'æ¸©æŸ”è°¦å‘', 'å–„è‰¯å¿ åš',
                
                // é‡è¦åŠ¨ä½œå’ŒçŠ¶æ€
                'ç§°ä¹‰ç§°ä¹‰', 'æˆåœ£æˆä¹‰', 'é‡ç”Ÿå¾—æ•‘', 'æ´å‡€æ›´æ–°', 'èµ¦å…ç½ªå­½',
                'éµå®ˆå‘½ä»¤', 'é¡ºæœçœŸç†', 'ä¿¡é ä¸Šå¸', 'æ•¬æ‹œç¥', 'èµç¾ä¸»',
                'å¥‰çŒ®è‡ªå·±', 'äº‹å¥‰ä¸Šå¸', 'è£è€€ç¥', 'è§è¯åŸºç£',
                
                // å±çµç”Ÿæ´»å’Œå®è·µ
                'ç¥·å‘Šäº¤é€š', 'è¯»ç»ç¥ˆç¥·', 'æ•Œæ‹œèµç¾', 'ä¼ ç¦éŸ³', 'ä½œè§è¯',
                'çˆ±äººå¦‚å·±', 'å½¼æ­¤ç›¸çˆ±', 'äº’ç›¸å»ºç«‹', 'ä¸€åŒäº‹å¥‰', 'åŒå¿ƒåˆæ„',
                
                // æ•‘æ©å’Œæ©å…¸
                'æ°¸è¿œçš„ç”Ÿå‘½', 'æ°¸ç”Ÿçš„ç›¼æœ›', 'æ•‘æ©çš„æ¯æ¯', 'ç¦éŸ³çš„å¤§èƒ½',
                'æ©å…¸çš„ä¸°ç››', 'æ…ˆçˆ±çš„å¤©çˆ¶', 'å…¬ä¹‰çš„å¤ªé˜³', 'å¹³å®‰çš„ç¦éŸ³'
            ];
            
            // é¦–å…ˆæœç´¢é«˜ä¼˜å…ˆçº§çš„å®Œæ•´è¯ç»„
            phrasePatterns.forEach(phrase => {
                const index = text.indexOf(phrase);
                if (index !== -1 && phrase.length >= 2 && phrase.length <= 7) {
                    meaningfulWords.push({
                        word: phrase,
                        index: index,
                        category: 'important-phrase',
                        priority: phrase.length * 4, // é«˜ä¼˜å…ˆçº§
                        length: phrase.length
                    });
                }
            });
            
            // ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æå–å…¶ä»–æœ‰æ„ä¹‰çš„è¯ç»„ï¼ˆ2-7å­—ï¼‰
            const phraseRegex = /[ä¸€-é¾¥]{2,7}/g;
            let match;
            
            while ((match = phraseRegex.exec(text)) !== null) {
                const phrase = match[0];
                const index = match.index;
                
                // è¿‡æ»¤æ‰å¸¸è§çš„è™šè¯å’Œä¸å®Œæ•´çš„è¯ç»„
                if (!isCommonWord(phrase) && 
                    !meaningfulWords.find(w => w.word === phrase)) {
                    
                    let priority = phrase.length;
                    
                    // æ ¹æ®è¯ç»„ç‰¹ç‚¹è°ƒæ•´ä¼˜å…ˆçº§
                    if (isTheologicalTerm(phrase)) {
                        priority *= 3;
                    } else if (isVerbPhrase(phrase)) {
                        priority *= 2.5;
                    } else if (isQualityPhrase(phrase)) {
                        priority *= 2;
                    }
                    
                    meaningfulWords.push({
                        word: phrase,
                        index: index,
                        category: 'phrase',
                        priority: priority,
                        length: phrase.length
                    });
                }
            }
            
            // æŒ‰ä¼˜å…ˆçº§æ’åºï¼Œé€‰æ‹©æœ€æœ‰æ„ä¹‰çš„è¯ç»„
            return meaningfulWords.sort((a, b) => b.priority - a.priority);
        }
        
        // åˆ¤æ–­æ˜¯å¦ä¸ºå¸¸è§è™šè¯
        function isCommonWord(phrase) {
            const commonWords = [
                'çš„äºº', 'äº†å—', 'è¿˜æ˜¯', 'å°±æ˜¯', 'éƒ½æ˜¯', 'ä¹Ÿæ˜¯', 'ä¸æ˜¯', 
                'å¯ä»¥', 'åº”è¯¥', 'å¯èƒ½', 'ä¹Ÿè®¸', 'æˆ–è€…', 'ä½†æ˜¯', 'è€Œä¸”',
                'å¦‚æœ', 'å› ä¸º', 'æ‰€ä»¥', 'ç„¶å', 'äºæ˜¯', 'å› æ­¤', 'ç„¶è€Œ',
                'è¿™ä¸ª', 'é‚£ä¸ª', 'è¿™äº›', 'é‚£äº›', 'è¿™æ ·', 'é‚£æ ·',
                'ä»€ä¹ˆ', 'æ€ä¹ˆ', 'ä¸ºä»€ä¹ˆ', 'å“ªé‡Œ', 'æ€æ ·'
            ];
            
            return commonWords.some(word => phrase.includes(word)) || 
                   /^[ï¼Œã€‚ï¼›ï¼šï¼ï¼Ÿâ€œâ€â€˜â€™ï¼ˆï¼‰ã€ã€‘ã€Šã€‹]+$/.test(phrase);
        }
        
        // åˆ¤æ–­æ˜¯å¦ä¸ºç¥å­¦æœ¯è¯­
        function isTheologicalTerm(phrase) {
            const theologicalTerms = [
                'ç¥', 'ä¸Šå¸', 'è€¶ç¨£', 'åŸºç£', 'åœ£çµ', 'ä¸»', 'çˆ¶', 'å¤©çˆ¶',
                'æ•‘ä¸»', 'åˆ›é€ ', 'æ°¸ç”Ÿ', 'å›½åº¦', 'å¤©å›½', 'åœ£æ´', 'å…¬ä¹‰'
            ];
            return theologicalTerms.some(term => phrase.includes(term));
        }
        
        // åˆ¤æ–­æ˜¯å¦ä¸ºåŠ¨è¯è¯ç»„
        function isVerbPhrase(phrase) {
            const verbKeywords = [
                'ç§°ä¹‰', 'æˆåœ£', 'æ‹¯æ•‘', 'èµ¦å…', 'æ´å‡€', 'æ›´æ–°', 'é‡ç”Ÿ',
                'æ•¬æ‹œ', 'èµç¾', 'äº‹å¥‰', 'éµå®ˆ', 'é¡ºæœ', 'ç›¸ä¿¡'
            ];
            return verbKeywords.some(verb => phrase.includes(verb));
        }
        
        // åˆ¤æ–­æ˜¯å¦ä¸ºå“è´¨è¯ç»„
        function isQualityPhrase(phrase) {
            const qualityKeywords = [
                'æ…ˆçˆ±', 'æ©å…¸', 'å¹³å®‰', 'å–œä¹', 'ç›¼æœ›', 'ä¿¡å¿ƒ', 'çˆ±å¿ƒ',
                'å¿è€', 'è‰¯å–„', 'æ¸©æŸ”', 'è°¦å‘', 'æ™ºæ…§', 'èƒ½åŠ›'
            ];
            return qualityKeywords.some(quality => phrase.includes(quality));
        }
        
        // é€‰æ‹©ç”¨äºå¡«ç©ºçš„è¯è¯­
        function selectWordsForBlanks(meaningfulWords, text) {
            const maxBlanks = Math.min(3, Math.max(1, Math.floor(text.length / 12))); // é™åˆ¶æœ€å¤š3ä¸ªå¡«ç©º
            const selectedWords = [];
            const usedIndices = new Set();
            
            for (let word of meaningfulWords) {
                if (selectedWords.length >= maxBlanks) break;
                
                // é™åˆ¶è¯è¯­é•¿åº¦ä¸º2-7å­—ï¼Œç¡®ä¿æ˜¯æœ‰æ„ä¹‰çš„è¯ç»„
                if (word.word.length < 2 || word.word.length > 7) continue;
                
                // æ£€æŸ¥æ˜¯å¦ä¸å·²é€‰è¯è¯­æœ‰é‡å 
                let hasOverlap = false;
                const wordEnd = word.index + word.word.length;
                
                for (let i = word.index; i < wordEnd; i++) {
                    if (usedIndices.has(i)) {
                        hasOverlap = true;
                        break;
                    }
                }
                
                if (!hasOverlap) {
                    selectedWords.push(word);
                    // æ ‡è®°ä½¿ç”¨çš„å­—ç¬¦ä½ç½®
                    for (let i = word.index; i < wordEnd; i++) {
                        usedIndices.add(i);
                    }
                }
            }
            
            return selectedWords;
        }
        
        // åˆå¹¶ç›¸é‚»çš„è¾“å…¥æ¡†ï¼Œé¿å…è¿ç»­ç©ºæ ¼æ˜¾å¾—æ²¡æœ‰æ„ä¹‰
        function mergeAdjacentInputs(html) {
            // ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…ç›¸é‚»çš„è¾“å…¥æ¡†ï¼ˆä¸­é—´æ²¡æœ‰æ±‰å­—ï¼‰
            return html.replace(
                /(<input[^>]*>)\s*(<input[^>]*>)/g,
                function(match, input1, input2) {
                    // æå–ä¸¤ä¸ªè¾“å…¥æ¡†çš„ç­”æ¡ˆ
                    const answer1 = input1.match(/data-answer="([^"]*)"/) || ['', ''];
                    const answer2 = input2.match(/data-answer="([^"]*)"/) || ['', ''];
                    
                    // åˆå¹¶ç­”æ¡ˆ
                    const combinedAnswer = answer1[1] + answer2[1];
                    const baseWidth = calculateInputWidth(combinedAnswer);
                    const fixedWidth = Math.max(baseWidth + 10, 70); // åˆå¹¶åçš„æœ€å°å®½åº¦70px
                    const placeholder = 'â–¡'.repeat(combinedAnswer.length);
                    
                    return `<input type="text" class="fill-blank-input" data-answer="${combinedAnswer}" placeholder="${placeholder}" style="width: ${fixedWidth}px; min-width: ${fixedWidth}px; max-width: ${fixedWidth}px;">`;
                }
            );
        }
        
        // åŠ¨æ€è°ƒæ•´è¾“å…¥æ¡†å®½åº¦
        function adjustInputWidth(input) {
            const value = input.value || input.placeholder || '';
            const answerLength = input.dataset.answer ? input.dataset.answer.length : 1;
            
            // ä½¿ç”¨å½“å‰è¾“å…¥å€¼æˆ–ç­”æ¡ˆé•¿åº¦æ¥è®¡ç®—å®½åº¦
            const textToMeasure = value.length > 0 ? value : input.dataset.answer;
            let width = calculateInputWidth(textToMeasure || '?');
            
            // å¦‚æœç”¨æˆ·æ­£åœ¨è¾“å…¥ï¼Œç»™ä¸€äº›é¢å¤–ç©ºé—´
            if (value.length > 0) {
                width += 10;
            }
            
            input.style.width = width + 'px';
        }
        
        // ç”Ÿæˆå¡«ç©ºç»ƒä¹ 
        function generateFillBlank(mode = 'random') {
            const keyVersesOfChapter = bookData.keyVerses.filter(kv => kv.chapter === currentChapter);
            
            // è®¾ç½®å½“å‰ç»ƒä¹ æ¨¡å¼
            currentExerciseMode = mode;
            
            // éšè—é‡æ–°æµ‹è¯„æŒ‰é’®
            const recheckBtn = document.getElementById('recheck-btn');
            if (recheckBtn) {
                recheckBtn.style.display = 'none';
            }
            
            if (mode === 'random' && keyVersesOfChapter.length === 0) {
                document.getElementById('fill-blank-content').innerHTML = '<p>æœ¬ç« æš‚æ— é‡‘å¥å¯ç»ƒä¹ </p>';
                return;
            }
            
            // æ ¹æ®æ¨¡å¼é€‰æ‹©åˆé€‚çš„ç»æ–‡
            const selectedVerseInfo = selectVerseByMode(keyVersesOfChapter, mode);
            
            if (!selectedVerseInfo) {
                // å¤„ç†ç»ƒä¹ å®Œæˆçš„æƒ…å†µ
                handleExerciseCompletion(mode);
                return;
            }
            
            // è®°å½•å½“å‰ç»ƒä¹ çš„ç»æ–‡
            currentExerciseVerse = selectedVerseInfo;
            
            const verse = bookData.verses.find(v => v.chapter === selectedVerseInfo.chapter && v.verse === selectedVerseInfo.verse);
            
            if (!verse) return;
            
            // åˆ›å»ºæœ‰æ„ä¹‰çš„å¡«ç©ºé¢˜
            const meaningfulWords = extractMeaningfulWords(verse.zh);
            const selectedWords = selectWordsForBlanks(meaningfulWords, verse.zh);
            
            let blankedVerse = verse.zh;
            // æŒ‰ç…§è¯è¯­é•¿åº¦ä»é•¿åˆ°çŸ­æ’åºï¼Œé¿å…æ›¿æ¢å†²çª
            selectedWords.sort((a, b) => b.word.length - a.word.length);
            
            selectedWords.forEach(wordInfo => {
                // è®¡ç®—å›ºå®šå®½åº¦ï¼Œé€‚åº¦å¢åŠ ç©ºé—´ä½†é˜²æ­¢è¿‡å®½
                const baseWidth = calculateInputWidth(wordInfo.word);
                const fixedWidth = Math.max(baseWidth + 10, 50); // æœ€å°50pxï¼Œå¢åŠ 10pxç¼“å†²
                const placeholder = 'â–¡'.repeat(wordInfo.word.length);
                const inputHTML = `<input type="text" class="fill-blank-input" data-answer="${wordInfo.word}" placeholder="${placeholder}" style="width: ${fixedWidth}px; min-width: ${fixedWidth}px; max-width: ${fixedWidth}px;">`;
                
                // åªæ›¿æ¢ç¬¬ä¸€ä¸ªåŒ¹é…çš„è¯è¯­
                blankedVerse = blankedVerse.replace(wordInfo.word, inputHTML);
            });
            
            // åˆå¹¶ç›¸é‚»çš„è¾“å…¥æ¡†ï¼Œé¿å…è¿ç»­ç©ºæ ¼
            blankedVerse = mergeAdjacentInputs(blankedVerse);
            
            // æ ¹æ®æ¨¡å¼æ˜¾ç¤ºä¸åŒçš„æç¤ºä¿¡æ¯
            let modeInfo = '';
            let modeIcon = '';
            if (mode === 'preview') {
                modeInfo = 'é¢„ä¹ æ¨¡å¼';
                modeIcon = 'ğŸ“š';
            } else if (mode === 'review') {
                modeInfo = 'å¤ä¹ æ¨¡å¼';
                modeIcon = 'ğŸ”„';
            } else {
                modeInfo = 'é‡‘å¥ç»ƒä¹ ';
                modeIcon = 'âœ¨';
            }
            
            document.getElementById('fill-blank-content').innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <div>
                        <p><strong>${bookData.name} ${selectedVerseInfo.chapter}:${selectedVerseInfo.verse}</strong></p>
                        <button onclick="scrollToVerse(${selectedVerseInfo.chapter}, ${selectedVerseInfo.verse})" 
                                style="background: #74b9ff; color: white; border: none; padding: 3px 8px; border-radius: 10px; font-size: 0.7em; cursor: pointer; margin-top: 2px;">
                            ğŸ“– å®šä½ç»æ–‡
                        </button>
                    </div>
                    <span style="background: rgba(116, 185, 255, 0.1); color: #0984e3; padding: 4px 8px; border-radius: 12px; font-size: 0.8em; font-weight: bold;">
                        ${modeIcon} ${modeInfo}
                    </span>
                </div>
                <p style="color: #7f8c8d; font-size: 0.9em; margin: 10px 0;">ğŸ’¡ è¯·å¡«å…¥å…³é”®è¯è¯­å®Œæˆç»æ–‡ï¼ˆâ–¡è¡¨ç¤ºéœ€è¦å¡«å…¥çš„å­—ç¬¦æ•°é‡ï¼‰</p>
                <p style="line-height: 2; margin: 15px 0;">${blankedVerse}</p>
                <p style="font-style: italic; color: #666; margin-bottom: 15px;">${verse.en}</p>
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button class="check-button" onclick="checkFillBlank(this)">æ ¸å¯¹ç­”æ¡ˆ</button>
                    <button class="check-button" onclick="recheckFillBlank(this)" style="background: #f39c12; display: none;" id="recheck-btn">é‡æ–°æµ‹è¯„</button>
                    <button class="check-button" onclick="generateFillBlank('${mode}')" style="background: #74b9ff; display: none;" id="next-question-btn">ä¸‹ä¸€é¢˜</button>
                </div>
                <div id="fill-result" style="margin-top: 15px;"></div>
            `;
            
            // ä¸ºæ–°åˆ›å»ºçš„è¾“å…¥æ¡†æ·»åŠ åŸºæœ¬äº‹ä»¶ç›‘å¬å™¨ï¼ˆä¸å†åŠ¨æ€è°ƒæ•´å®½åº¦ï¼‰
            const inputs = document.getElementById('fill-blank-content').querySelectorAll('.fill-blank-input');
            inputs.forEach(input => {
                // æ·»åŠ èšç„¦æ•ˆæœï¼Œä½†ä¸è°ƒæ•´å®½åº¦
                input.addEventListener('focus', function() {
                    this.style.transform = 'scale(1.05)';
                });
                
                input.addEventListener('blur', function() {
                    this.style.transform = 'scale(1)';
                });
            });
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            updateExerciseButtonsState();
        }

        // é‡æ–°æµ‹è¯„å¡«ç©ºç­”æ¡ˆ
        function recheckFillBlank(button) {
            // é‡ç½®ç»“æœæ˜¾ç¤º
            const resultElement = document.getElementById('fill-result');
            resultElement.innerHTML = '';
            
            // éšè—é‡æ–°æµ‹è¯„æŒ‰é’®
            const recheckBtn = document.getElementById('recheck-btn');
            if (recheckBtn) {
                recheckBtn.style.display = 'none';
            }
            
            // æ¸…é™¤æ‰€æœ‰ä¹‹å‰çš„æ­£ç¡®ç­”æ¡ˆæ˜¾ç¤º
            const card = button.closest('.fill-blank-card');
            const allExistingAnswers = card.querySelectorAll('.correct-answer');
            allExistingAnswers.forEach(answer => answer.remove());
            
            // è°ƒç”¨æ£€æŸ¥å‡½æ•°
            checkFillBlank(button, true);
        }
        
        // æ£€æŸ¥å¡«ç©ºç­”æ¡ˆ
        function checkFillBlank(button, isRecheck = false) {
            const card = button.closest('.fill-blank-card');
            const inputs = card.querySelectorAll('.fill-blank-input');
            let allCorrect = true;
            let correctCount = 0;
            
            // å…ˆæ¸…é™¤æ‰€æœ‰ä¹‹å‰çš„æ­£ç¡®ç­”æ¡ˆæ˜¾ç¤º
            const allExistingAnswers = card.querySelectorAll('.correct-answer');
            allExistingAnswers.forEach(answer => answer.remove());
            
            inputs.forEach(input => {
                input.classList.remove('correct', 'incorrect');
                
                const userAnswer = input.value.trim().replace(/\s+/g, ''); // å»é™¤æ‰€æœ‰ç©ºæ ¼
                const correctAnswer = input.dataset.answer.replace(/\s+/g, '');
                
                if (userAnswer === correctAnswer || userAnswer.toLowerCase() === correctAnswer.toLowerCase()) {
                    input.classList.add('correct');
                    correctCount++;
                } else {
                    input.classList.add('incorrect');
                    allCorrect = false;
                    
                    // åˆ›å»ºæ­£ç¡®ç­”æ¡ˆæ˜¾ç¤ºå…ƒç´ 
                    const correctAnswerSpan = document.createElement('span');
                    correctAnswerSpan.className = 'correct-answer';
                    correctAnswerSpan.style.cssText = 'color: #27ae60; margin-left: 5px; font-size: 0.85em; font-weight: bold; display: inline-block; white-space: nowrap;';
                    correctAnswerSpan.textContent = `(${input.dataset.answer})`;
                    
                    // åœ¨è¾“å…¥æ¡†åæ’å…¥æ­£ç¡®ç­”æ¡ˆ
                    const container = input.parentElement;
                    const nextElement = input.nextSibling;
                    
                    if (nextElement) {
                        container.insertBefore(correctAnswerSpan, nextElement);
                    } else {
                        container.appendChild(correctAnswerSpan);
                    }
                    
                    console.log(`æ·»åŠ æ­£ç¡®ç­”æ¡ˆæ˜¾ç¤º: ${input.dataset.answer}`);
                }
            });
            
            const resultElement = document.getElementById('fill-result');
            const recheckBtn = document.getElementById('recheck-btn');
            
            if (allCorrect) {
                resultElement.innerHTML = `<span style="color: #27ae60;">ğŸ‰ å®Œå…¨æ­£ç¡®ï¼æ­å–œä½ ï¼</span>`;
                
                // éšè—é‡æ–°æµ‹è¯„æŒ‰é’®
                if (recheckBtn) {
                    recheckBtn.style.display = 'none';
                }
                
                // å¦‚æœæ˜¯é¢„ä¹ æ¨¡å¼ä¸”ç­”æ¡ˆå®Œå…¨æ­£ç¡®ï¼Œè‡ªåŠ¨æ‰“å‹¾
                if (currentExerciseMode === 'preview' && currentExerciseVerse) {
                    const checkbox = document.getElementById(`check-${currentExerciseVerse.chapter}-${currentExerciseVerse.verse}`);
                    if (checkbox && !checkbox.checked) {
                        checkbox.checked = true;
                        saveProgress(currentExerciseVerse.chapter, currentExerciseVerse.verse);
                        resultElement.innerHTML += `<br><span style="color: #27ae60; font-size: 0.9em;">âœ“ å·²è‡ªåŠ¨æ‰“å‹¾æ­¤ç»æ–‡</span>`;
                    }
                }
                
                // æ ‡è®°ä¸ºå·²ç»ƒä¹ 
                if (currentExerciseVerse) {
                    const verseKey = `${currentExerciseVerse.chapter}:${currentExerciseVerse.verse}`;
                    exercisedVerses.add(verseKey);
                }
                
            } else {
                resultElement.innerHTML = `<span style="color: #e67e22;">ğŸ“š ç­”å¯¹äº† ${correctCount}/${inputs.length} æ ¼ï¼Œç»§ç»­åŠ æ²¹ï¼</span>`;
                
                // æ˜¾ç¤ºé‡æ–°æµ‹è¯„æŒ‰é’®ï¼ˆå¦‚æœä¸æ˜¯é‡æ–°æ£€æŸ¥æ“ä½œï¼‰
                if (recheckBtn && !isRecheck) {
                    recheckBtn.style.display = 'inline-block';
                }
            }
            
            // æ˜¾ç¤ºä¸‹ä¸€é¢˜æŒ‰é’®ï¼ˆä»…åœ¨å®Œå…¨æ­£ç¡®æ—¶ï¼‰
            const nextBtn = document.getElementById('next-question-btn');
            if (nextBtn) {
                if (allCorrect) {
                    nextBtn.style.display = 'block';
                    nextBtn.textContent = 'ä¸‹ä¸€é¢˜';
                } else {
                    nextBtn.style.display = 'none';
                }
            }
            
            // ä¿®æ”¹å½“å‰æŒ‰é’®ä¸ºé‡æ–°å¼€å§‹
            button.textContent = 'é‡æ–°å¼€å§‹';
            button.onclick = () => {
                // éšè—ä¸‹ä¸€é¢˜æŒ‰é’®
                if (nextBtn) nextBtn.style.display = 'none';
                // é‡ç½®ç»ƒä¹ çŠ¶æ€
                exercisedVerses.clear();
                currentExerciseVerse = null;
                generateFillBlank(currentExerciseMode);
            };
        }

        // æ»šåŠ¨åˆ°æŒ‡å®šç»æ–‡
        function scrollToVerse(chapter, verse) {
            const verseRow = document.querySelector(`tr[data-chapter="${chapter}"][data-verse="${verse}"]`);
            if (verseRow) {
                const versesSection = document.querySelector('.verses-section');
                const rowOffset = verseRow.offsetTop;
                const sectionOffset = versesSection.offsetTop;
                const scrollTarget = rowOffset - sectionOffset - 20; // 20px çš„åç§»é‡
                
                versesSection.scrollTo({
                    top: scrollTarget,
                    behavior: 'smooth'
                });
                
                // é«˜äº®æ˜¾ç¤ºè¯¥ç»æ–‡
                verseRow.style.backgroundColor = 'rgba(116, 185, 255, 0.2)';
                setTimeout(() => {
                    verseRow.style.backgroundColor = '';
                }, 2000);
            }
        }

        // æ˜¾ç¤ºèƒŒæ™¯ä¿¡æ¯
        function showBackground(verse) {
            const modal = document.getElementById('background-modal');
            document.getElementById('modal-title').textContent = `${bookData.name} ${verse.chapter}:${verse.verse}`;
            document.getElementById('modal-body').innerHTML = verse.background;
            modal.style.display = 'block';
        }

        // ä¿å­˜è¿›åº¦
        function saveProgress(chapter, verse) {
            const key = `${currentBook}-${chapter}-${verse}`;
            const checkbox = document.getElementById(`check-${chapter}-${verse}`);
            progressData[key] = checkbox.checked;
            localStorage.setItem('bible-study-progress', JSON.stringify(progressData));
            updateProgressSummary();
        }

        // åŠ è½½è¿›åº¦
        function loadProgress() {
            const saved = localStorage.getItem('bible-study-progress');
            progressData = saved ? JSON.parse(saved) : {};
        }
        
        // è·å–å½“å‰ç« èŠ‚çš„è¿›åº¦æ•°æ®
        function getProgress() {
            const progress = {};
            const keyVersesOfChapter = bookData.keyVerses.filter(kv => kv.chapter === currentChapter);
            
            keyVersesOfChapter.forEach(kv => {
                const key = `${currentBook}-${kv.chapter}-${kv.verse}`;
                const verseKey = `${kv.chapter}:${kv.verse}`;
                progress[verseKey] = progressData[key] || false;
            });
            
            return progress;
        }

        // æ›´æ–°è¿›åº¦æ‘˜è¦
        function updateProgressSummary() {
            const chapterVerses = bookData.verses.filter(v => v.chapter === currentChapter);
            const completedInChapter = chapterVerses.filter(v => {
                const key = `${currentBook}-${v.chapter}-${v.verse}`;
                return progressData[key];
            }).length;
            
            const totalCompleted = bookData.verses.filter(v => {
                const key = `${currentBook}-${v.chapter}-${v.verse}`;
                return progressData[key];
            }).length;
            
            // ç»Ÿè®¡å½“å‰ç« èŠ‚é‡‘å¥çš„é¢„ä¹ å’Œå¤ä¹ çŠ¶æ€ï¼ˆåŸºäºæ‰€æœ‰ç»æ–‡ï¼Œä¸ä»…æ˜¯é‡‘å¥ï¼‰
            const keyVersesOfChapter = bookData.keyVerses.filter(kv => kv.chapter === currentChapter);
            const checkedKeyVerses = keyVersesOfChapter.filter(kv => {
                const key = `${currentBook}-${kv.chapter}-${kv.verse}`;
                return progressData[key] || false;
            }).length;
            
            // ä¿®æ­£ç»Ÿè®¡æ•°æ®ï¼šå¾…é¢„ä¹  = æœªæ‰“å‹¾çš„ç»æ–‡æ•°ï¼Œå¯å¤ä¹  = å·²æ‰“å‹¾çš„ç»æ–‡æ•°
            const uncheckedInChapter = chapterVerses.length - completedInChapter;
            const previewCount = uncheckedInChapter;
            const reviewCount = completedInChapter;
            
            document.getElementById('current-progress').textContent = `${completedInChapter}/${chapterVerses.length}`;
            document.getElementById('total-progress').textContent = `${totalCompleted}/${bookData.verses.length}`;
            
            // æ›´æ–°ç»ƒä¹ ç»Ÿè®¡
            const exerciseStats = document.getElementById('exercise-stats') || createExerciseStats();
            exerciseStats.innerHTML = `
                <div style="display: flex; justify-content: space-between; margin: 10px 0; font-size: 0.9em;">
                    <div style="text-align: center;">
                        <div style="color: #74b9ff; font-weight: bold;">${previewCount}</div>
                        <div style="color: #7f8c8d; font-size: 0.8em;">å¾…é¢„ä¹ </div>
                    </div>
                    <div style="text-align: center;">
                        <div style="color: #fd79a8; font-weight: bold;">${reviewCount}</div>
                        <div style="color: #7f8c8d; font-size: 0.8em;">å¯å¤ä¹ </div>
                    </div>
                    <div style="text-align: center;">
                        <div style="color: #fdcb6e; font-weight: bold;">${keyVersesOfChapter.length}</div>
                        <div style="color: #7f8c8d; font-size: 0.8em;">é‡‘å¥æ€»æ•°</div>
                    </div>
                </div>
            `;
            
            // æ›´æ–°ç»ƒä¹ æŒ‰é’®çŠ¶æ€
            updateExerciseButtonsState();
        }
        
        // åˆ›å»ºç»ƒä¹ ç»Ÿè®¡åŒºåŸŸ
        function createExerciseStats() {
            const progressSummary = document.getElementById('progress-summary');
            const exerciseStats = document.createElement('div');
            exerciseStats.id = 'exercise-stats';
            progressSummary.appendChild(exerciseStats);
            return exerciseStats;
        }

        // æ¨¡æ€æ¡†äº‹ä»¶
        document.addEventListener('DOMContentLoaded', () => {
            const modal = document.getElementById('background-modal');
            const closeBtn = document.querySelector('.close');
            
            closeBtn.onclick = () => modal.style.display = 'none';
            window.onclick = (event) => {
                if (event.target === modal) modal.style.display = 'none';
            };
        });
    </script>
</body>
</html>